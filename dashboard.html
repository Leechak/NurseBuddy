<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>NurseBuddy Dashboard</title>
  <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Sarabun', sans-serif;
      background: linear-gradient(135deg, #f0f9ff, #e0f2fe);
      min-height: 100vh;
      padding: 10px;
    }

    .header {
      background: linear-gradient(135deg, #0ea5e9, #0284c7);
      color: white;
      padding: 25px;
      border-radius: 15px;
      margin-bottom: 25px;
      text-align: center;
      box-shadow: 0 8px 25px rgba(14, 165, 233, 0.3);
      position: relative;
      overflow: hidden;
    }

    .header::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="20" cy="20" r="2" fill="rgba(255,255,255,0.1)"/><circle cx="80" cy="80" r="2" fill="rgba(255,255,255,0.1)"/></svg>');
      pointer-events: none;
    }

    .header h1 {
      font-size: 28px;
      margin-bottom: 8px;
      position: relative;
      z-index: 1;
    }

    .header p {
      font-size: 16px;
      opacity: 0.9;
      position: relative;
      z-index: 1;
    }

    .user-info {
      background: rgba(255,255,255,0.2);
      padding: 12px 20px;
      border-radius: 10px;
      font-size: 14px;
      margin-top: 15px;
      display: inline-block;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255,255,255,0.3);
      position: relative;
      z-index: 1;
    }

    .quick-actions {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .action-card {
      background: white;
      border-radius: 15px;
      padding: 25px;
      text-align: center;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
      cursor: pointer;
      transition: all 0.3s ease;
      border: 2px solid transparent;
      position: relative;
      overflow: hidden;
    }

    .action-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(135deg, #0ea5e9, #0284c7);
      transform: scaleX(0);
      transition: transform 0.3s ease;
    }

    .action-card:hover {
      transform: translateY(-8px);
      border-color: #0ea5e9;
      box-shadow: 0 12px 35px rgba(14, 165, 233, 0.25);
    }

    .action-card:active {
      transform: translateY(-4px);
    }

    .action-icon {
      font-size: 56px;
      margin-bottom: 20px;
      display: block;
    }

    .action-title {
      font-size: 20px;
      font-weight: 600;
      color: #1e293b;
      margin-bottom: 8px;
    }

    .action-desc {
      font-size: 14px;
      color: #64748b;
      line-height: 1.5;
    }

    .beds-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
      gap: 25px;
      margin-bottom: 30px;
    }

    .bed-card {
      background: white;
      border-radius: 20px;
      padding: 0;
      box-shadow: 0 8px 30px rgba(0,0,0,0.12);
      transition: all 0.4s ease;
      cursor: pointer;
      text-decoration: none;
      color: inherit;
      position: relative;
      border: 3px solid transparent;
      overflow: hidden;
    }

    .bed-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 6px;
      background: linear-gradient(135deg, #0ea5e9, #0284c7);
      transform: scaleX(0);
      transition: transform 0.4s ease;
    }

    .bed-card:hover::before {
      transform: scaleX(1);
    }

    .bed-card:hover {
      transform: translateY(-10px) scale(1.02);
      box-shadow: 0 20px 50px rgba(14, 165, 233, 0.2);
      border-color: rgba(14, 165, 233, 0.3);
    }

    .bed-card:active {
      transform: translateY(-5px) scale(1.01);
    }

    .bed-header {
      background: linear-gradient(135deg, #f8fafc, #f1f5f9);
      padding: 20px 25px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid #e2e8f0;
      position: relative;
    }

    .bed-number {
      font-size: 22px;
      font-weight: 800;
      color: #1e293b;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .bed-icon {
      font-size: 24px;
      padding: 8px;
      background: linear-gradient(135deg, #e0f2fe, #bae6fd);
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .status-indicator {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
    }

    .status-dot {
      width: 16px;
      height: 16px;
      border-radius: 50%;
      background: #22c55e;
      animation: pulse 2s infinite;
      box-shadow: 0 0 0 6px rgba(34, 197, 94, 0.2);
      position: relative;
    }

    .status-dot::after {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: white;
    }

    .status-dot.inactive {
      background: #94a3b8;
      animation: none;
      box-shadow: 0 0 0 6px rgba(148, 163, 184, 0.2);
    }

    .status-dot.warning {
      background: #f59e0b;
      box-shadow: 0 0 0 6px rgba(245, 158, 11, 0.2);
    }

    .status-dot.error {
      background: #ef4444;
      box-shadow: 0 0 0 6px rgba(239, 68, 68, 0.2);
    }

    .status-text {
      font-size: 10px;
      font-weight: 600;
      color: #64748b;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    @keyframes pulse {
      0%, 100% { 
        opacity: 1; 
        transform: scale(1);
      }
      50% { 
        opacity: 0.6; 
        transform: scale(1.2);
      }
    }

    .bed-content {
      padding: 25px;
    }

    .flow-rate-section {
      background: linear-gradient(135deg, #f0f9ff, #e0f2fe);
      padding: 20px;
      border-radius: 15px;
      margin-bottom: 20px;
      text-align: center;
      border: 2px solid rgba(14, 165, 233, 0.1);
    }

    .flow-rate {
      font-size: 24px;
      font-weight: 800;
      color: #0ea5e9;
      margin-bottom: 5px;
      display: block;
    }

    .flow-rate-label {
      font-size: 12px;
      color: #0369a1;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .patient-info {
      background: linear-gradient(135deg, #fafafa, #f5f5f5);
      padding: 20px;
      border-radius: 15px;
      margin-bottom: 15px;
      border: 2px solid #e5e7eb;
      position: relative;
      overflow: hidden;
    }

    .patient-info::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      bottom: 0;
      width: 4px;
      background: linear-gradient(135deg, #0ea5e9, #0284c7);
    }

    .patient-info-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
      padding: 8px 0;
    }

    .patient-info-row:last-child {
      margin-bottom: 0;
    }

    .patient-info-label {
      font-size: 12px;
      color: #64748b;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .patient-info-value {
      font-size: 14px;
      color: #1e293b;
      font-weight: 700;
      text-align: right;
    }

    .comparison-section {
      background: linear-gradient(135deg, #e0f2fe, #bae6fd);
      padding: 18px;
      border-radius: 12px;
      margin-bottom: 15px;
      border: 2px solid rgba(14, 165, 233, 0.2);
    }

    .comparison-header {
      font-size: 11px;
      color: #0c4a6e;
      font-weight: 700;
      margin-bottom: 12px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .comparison-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin-bottom: 12px;
    }

    .comparison-item {
      text-align: center;
      background: rgba(255, 255, 255, 0.8);
      padding: 12px 8px;
      border-radius: 8px;
      border: 1px solid rgba(14, 165, 233, 0.2);
    }

    .comparison-label {
      font-size: 10px;
      color: #0369a1;
      margin-bottom: 4px;
      font-weight: 600;
    }

    .comparison-value {
      font-size: 16px;
      font-weight: 800;
      color: #0ea5e9;
    }

    .variance-indicator {
      background: rgba(255, 255, 255, 0.9);
      padding: 8px 12px;
      border-radius: 8px;
      text-align: center;
      font-size: 11px;
      font-weight: 700;
      border: 1px solid rgba(14, 165, 233, 0.2);
    }

    .stats-row {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
      margin-bottom: 15px;
    }

    .stat-mini {
      background: linear-gradient(135deg, #f8fafc, #f1f5f9);
      padding: 12px 8px;
      border-radius: 10px;
      text-align: center;
      border: 1px solid #e2e8f0;
    }

    .stat-mini-value {
      font-size: 16px;
      font-weight: 800;
      color: #1e293b;
      margin-bottom: 2px;
    }

    .stat-mini-label {
      font-size: 9px;
      color: #64748b;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.3px;
    }

    .last-update {
      background: #f8fafc;
      padding: 12px 15px;
      border-radius: 10px;
      font-size: 10px;
      color: #64748b;
      text-align: center;
      margin-top: 15px;
      border: 1px solid #e2e8f0;
      font-weight: 500;
    }

    .empty-bed {
      text-align: center;
      padding: 40px 20px;
      background: linear-gradient(135deg, #f8fafc, #f1f5f9);
      border-radius: 15px;
      border: 2px dashed #cbd5e1;
      color: #64748b;
    }

    .empty-bed-icon {
      font-size: 48px;
      margin-bottom: 15px;
      opacity: 0.6;
    }

    .empty-bed-title {
      font-size: 16px;
      font-weight: 700;
      margin-bottom: 8px;
      color: #374151;
    }

    .empty-bed-desc {
      font-size: 12px;
      font-style: italic;
    }

    .summary-section {
      background: white;
      border-radius: 15px;
      padding: 30px;
      margin-bottom: 25px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
      border: 1px solid rgba(14, 165, 233, 0.1);
    }

    .summary-header {
      display: flex;
      align-items: center;
      margin-bottom: 25px;
      padding-bottom: 15px;
      border-bottom: 2px solid #f1f5f9;
    }

    .summary-title {
      font-size: 22px;
      font-weight: 700;
      color: #1e293b;
      margin-left: 15px;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 20px;
    }

    .stat-card {
      background: linear-gradient(135deg, #f1f5f9, #e2e8f0);
      padding: 20px;
      border-radius: 12px;
      text-align: center;
      transition: all 0.3s ease;
      border: 2px solid transparent;
      cursor: pointer;
    }

    .stat-card:hover {
      border-color: #0ea5e9;
      transform: translateY(-3px);
      box-shadow: 0 8px 25px rgba(14, 165, 233, 0.15);
    }

    .stat-value {
      font-size: 28px;
      font-weight: 700;
      color: #0ea5e9;
      margin-bottom: 8px;
    }

    .stat-label {
      font-size: 13px;
      color: #64748b;
      font-weight: 500;
    }

    .stat-detail {
      font-size: 11px;
      color: #64748b;
      margin-top: 5px;
    }

    .admin-controls {
      position: fixed;
      top: 20px;
      right: 20px;
      display: flex;
      gap: 12px;
      z-index: 1000;
    }

    .admin-btn {
      background: linear-gradient(135deg, #ef4444, #dc2626);
      color: white;
      border: none;
      padding: 14px 18px;
      border-radius: 10px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(239, 68, 68, 0.3);
      border: 1px solid rgba(255,255,255,0.1);
    }

    .admin-btn:hover {
      background: linear-gradient(135deg, #dc2626, #b91c1c);
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(239, 68, 68, 0.4);
    }

    .admin-btn:active {
      transform: translateY(0);
    }

    .admin-btn.secondary {
      background: linear-gradient(135deg, #64748b, #475569);
      box-shadow: 0 4px 15px rgba(100, 116, 139, 0.3);
    }

    .admin-btn.secondary:hover {
      background: linear-gradient(135deg, #475569, #334155);
      box-shadow: 0 6px 20px rgba(100, 116, 139, 0.4);
    }

    @media (max-width: 768px) {
      .quick-actions {
        grid-template-columns: repeat(2, 1fr);
        gap: 15px;
      }

      .beds-grid {
        grid-template-columns: repeat(2, 1fr);
        gap: 15px;
      }

      .admin-controls {
        position: relative;
        top: auto;
        right: auto;
        margin-bottom: 20px;
        justify-content: center;
        flex-wrap: wrap;
      }

      .stats-grid {
        grid-template-columns: repeat(2, 1fr);
        gap: 15px;
      }

      .action-card {
        padding: 18px;
      }

      .action-icon {
        font-size: 42px;
        margin-bottom: 12px;
      }

      .action-title {
        font-size: 16px;
      }

      .action-desc {
        font-size: 12px;
      }

      .bed-card {
        margin-bottom: 0;
      }

      .bed-header {
        padding: 15px 20px;
      }

      .bed-number {
        font-size: 18px;
      }

      .bed-content {
        padding: 20px;
      }

      .flow-rate {
        font-size: 20px;
      }

      .comparison-grid {
        gap: 8px;
      }

      .comparison-item {
        padding: 10px 6px;
      }

      .stats-row {
        gap: 8px;
      }

      .stat-mini {
        padding: 10px 6px;
      }

      .patient-info {
        padding: 15px;
      }

      .comparison-section {
        padding: 15px;
      }
    }

    @media (max-width: 480px) {
      body {
        padding: 8px;
      }

      .header {
        padding: 20px 15px;
        margin-bottom: 20px;
      }

      .header h1 {
        font-size: 22px;
      }

      .header p {
        font-size: 14px;
      }

      .user-info {
        font-size: 12px;
        padding: 10px 15px;
      }

      .quick-actions {
        grid-template-columns: 1fr;
        gap: 12px;
      }

      .beds-grid {
        grid-template-columns: 1fr;
        gap: 15px;
      }

      .stats-grid {
        grid-template-columns: 1fr;
        gap: 12px;
      }

      .admin-controls {
        gap: 8px;
      }

      .admin-btn {
        padding: 10px 14px;
        font-size: 12px;
      }

      .action-card {
        padding: 15px;
      }

      .action-icon {
        font-size: 36px;
        margin-bottom: 10px;
      }

      .action-title {
        font-size: 14px;
      }

      .action-desc {
        font-size: 11px;
      }

      .bed-header {
        padding: 12px 15px;
      }

      .bed-number {
        font-size: 16px;
      }

      .bed-icon {
        font-size: 20px;
        padding: 6px;
      }

      .bed-content {
        padding: 15px;
      }

      .flow-rate-section {
        padding: 15px;
        margin-bottom: 15px;
      }

      .flow-rate {
        font-size: 20px;
      }

      .flow-rate-label {
        font-size: 11px;
      }

      .patient-info {
        padding: 12px;
        margin-bottom: 12px;
      }

      .patient-info-row {
        padding: 6px 0;
        margin-bottom: 8px;
      }

      .patient-info-label {
        font-size: 11px;
      }

      .patient-info-value {
        font-size: 12px;
      }

      .comparison-section {
        padding: 12px;
        margin-bottom: 12px;
      }

      .comparison-header {
        font-size: 10px;
        margin-bottom: 8px;
      }

      .comparison-grid {
        gap: 6px;
        margin-bottom: 8px;
      }

      .comparison-item {
        padding: 8px 4px;
      }

      .comparison-label {
        font-size: 9px;
      }

      .comparison-value {
        font-size: 14px;
      }

      .variance-indicator {
        padding: 6px 8px;
        font-size: 10px;
      }

      .stats-row {
        gap: 6px;
        margin-bottom: 12px;
      }

      .stat-mini {
        padding: 8px 4px;
      }

      .stat-mini-value {
        font-size: 14px;
      }

      .stat-mini-label {
        font-size: 8px;
      }

      .last-update {
        padding: 8px 10px;
        margin-top: 12px;
        font-size: 9px;
      }

      .empty-bed {
        padding: 25px 15px;
      }

      .empty-bed-icon {
        font-size: 36px;
        margin-bottom: 10px;
      }

      .empty-bed-title {
        font-size: 14px;
        margin-bottom: 6px;
      }

      .empty-bed-desc {
        font-size: 11px;
      }

      .summary-section {
        padding: 20px 15px;
        margin-bottom: 20px;
      }

      .summary-title {
        font-size: 18px;
      }

      .stat-card {
        padding: 15px;
      }

      .stat-value {
        font-size: 22px;
      }

      .stat-label {
        font-size: 11px;
      }

      .stat-detail {
        font-size: 10px;
      }
    }

    .modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 2000;
      padding: 20px;
    }

    .modal-content {
      background: white;
      padding: 30px;
      border-radius: 15px;
      max-width: 500px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 20px 50px rgba(0,0,0,0.3);
    }

    .modal h3 {
      font-size: 20px;
      font-weight: 700;
      margin-bottom: 20px;
      color: #1e293b;
      padding-bottom: 10px;
      border-bottom: 2px solid #f1f5f9;
    }

    .btn {
      padding: 14px 24px;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      margin: 8px 5px;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
      position: relative;
      overflow: hidden;
    }

    .btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
      transition: left 0.5s;
    }

    .btn:hover::before {
      left: 100%;
    }

    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(0,0,0,0.15);
    }

    .btn:active {
      transform: translateY(0);
    }

    .btn-primary {
      background: linear-gradient(135deg, #0ea5e9, #0284c7);
      color: white;
    }

    .btn-secondary {
      background: linear-gradient(135deg, #64748b, #475569);
      color: white;
    }

    .btn-danger {
      background: linear-gradient(135deg, #ef4444, #dc2626);
      color: white;
    }

    .input-group {
      margin-bottom: 20px;
    }

    .input-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: #374151;
      font-size: 14px;
    }

    .input-group input,
    .input-group select {
      width: 100%;
      padding: 12px 15px;
      border: 2px solid #e5e7eb;
      border-radius: 10px;
      font-size: 14px;
      transition: all 0.3s ease;
    }

    .input-group input:focus,
    .input-group select:focus {
      border-color: #0ea5e9;
      outline: none;
      box-shadow: 0 0 0 3px rgba(14, 165, 233, 0.1);
    }

    .loading {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      color: #64748b;
      padding: 20px;
    }

    .spinner {
      width: 20px;
      height: 20px;
      border: 2px solid #e5e7eb;
      border-top: 2px solid #0ea5e9;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .empty-state {
      text-align: center;
      padding: 40px 20px;
      color: #64748b;
      font-style: italic;
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>🏥 NurseBuddy Dashboard</h1>
    <p>ระบบติดตามน้ำเกลืออัจฉริยะ เพื่อความปลอดภัยของผู้ป่วย</p>
    <div class="user-info" id="userInfo">👤 กำลังโหลด...</div>
  </div>

  <div class="admin-controls" id="adminControls" style="display: none;">
    <button class="admin-btn secondary" onclick="openSummaryModal()">📊 สรุป</button>
    <button class="admin-btn" onclick="openResetModal()">🗑️ รีเซ็ต</button>
    <button class="admin-btn secondary" onclick="logout()">🚪 ออก</button>
  </div>

  <div class="quick-actions">
    <div class="action-card" onclick="showQuickAdd()">
      <div class="action-icon">⚡</div>
      <div class="action-title">เพิ่มผู้ป่วยใหม่</div>
      <div class="action-desc">กรอกข้อมูลครั้งเดียว พร้อมใช้งานทันที</div>
    </div>

    <div class="action-card" onclick="showIOEntry()">
      <div class="action-icon">💧</div>
      <div class="action-title">บันทึก I/O</div>
      <div class="action-desc">บันทึกสารน้ำเข้า-ออกอย่างรวดเร็ว</div>
    </div>

    <div class="action-card" onclick="showQuickCalc()">
      <div class="action-icon">🧮</div>
      <div class="action-title">คำนวณน้ำเกลือ</div>
      <div class="action-desc">คำนวณอัตราการไหลแม่นยำทันที</div>
    </div>
  </div>

  <div class="summary-section">
    <div class="summary-header">
      <span style="font-size: 28px;">📊</span>
      <div class="summary-title">สรุปสถานะระบบ</div>
    </div>
    <div class="stats-grid">
        <div class="stat-card" onclick="showActiveBedsDetails()">
          <div class="stat-value" id="totalBeds">0</div>
          <div class="stat-label">เตียงที่ใช้งาน</div>
          <div class="stat-detail">คลิกเพื่อดูรายละเอียด</div>
        </div>
        <div class="stat-card" onclick="showNotesHistory()">
          <div class="stat-value" id="totalNotes">0</div>
          <div class="stat-label">บันทึกทั้งหมด</div>
          <div class="stat-detail">บันทึกการดูแลผู้ป่วย</div>
        </div>
        <div class="stat-card" onclick="showIOSummary()">
          <div class="stat-value" id="totalIORecords">0</div>
          <div class="stat-label">บันทึก I/O</div>
          <div class="stat-detail">สารน้ำเข้า-ออก</div>
        </div>
        <div class="stat-card" onclick="showVitalsSummary()">
          <div class="stat-value" id="totalVitals">0</div>
          <div class="stat-label">Vital Signs</div>
          <div class="stat-detail">การวัดสัญญาณชีพ</div>
        </div>
        <div class="stat-card" onclick="showMedicationSummary()">
          <div class="stat-value" id="totalMedications">0</div>
          <div class="stat-label">กำหนดการยา</div>
          <div class="stat-detail">ตารางให้ยา</div>
        </div>
        <div class="stat-card alert-card" onclick="showAlertsDetails()">
          <div class="stat-value" id="alertCount">0</div>
          <div class="stat-label">การแจ้งเตือน</div>
          <div class="stat-detail" id="alertDetail">ไม่มีการแจ้งเตือน</div>
        </div>
      </div>
  </div>

  <div class="beds-grid" id="bedsGrid">
    <div class="loading">
      <div class="spinner"></div>
      <span>กำลังโหลดข้อมูลเตียง...</span>
    </div>
  </div>

  <!-- Quick Add Modal -->
  <div class="modal" id="quickAddModal">
    <div class="modal-content">
      <h3>⚡ เพิ่มผู้ป่วยใหม่</h3>
      <div class="input-group">
        <label>เตียงที่:</label>
        <select id="bedSelect">
          <option value="">เลือกเตียง</option>
        </select>
      </div>
      <div class="input-group">
        <label>รหัสผู้ป่วย:</label>
        <input type="text" id="patientId" placeholder="P001234">
      </div>
      <div class="input-group">
        <label>ยา/สารน้ำ:</label>
        <select id="medication">
          <option value="Normal Saline">Normal Saline (0.9% NSS)</option>
          <option value="Dextrose 5%">Dextrose 5% in Water</option>
          <option value="Lactated Ringer's">Lactated Ringer's Solution</option>
          <option value="Dextrose 5% in NSS">D5NSS</option>
          <option value="Half Normal Saline">0.45% NSS</option>
        </select>
      </div>
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
        <div class="input-group">
          <label>ปริมาณ (mL):</label>
          <input type="number" id="volume" placeholder="500">
        </div>
        <div class="input-group">
          <label>อัตรา (ดรอป/นาที):</label>
          <input type="number" id="rate" placeholder="20">
        </div>
      </div>
      <button class="btn btn-primary" onclick="savePatient()">💾 บันทึกและไปที่เตียง</button>
      <button class="btn btn-secondary" onclick="closeModal('quickAddModal')">ยกเลิก</button>
    </div>
  </div>

  <!-- I/O Modal -->
  <div class="modal" id="ioModal">
    <div class="modal-content">
      <h3>💧 บันทึก I/O รวดเร็ว</h3>
      <div class="input-group">
        <label>เตียงที่:</label>
        <select id="ioBedSelect">
          <option value="">เลือกเตียง</option>
        </select>
      </div>
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
        <div>
          <h4 style="color: #22c55e; margin-bottom: 15px;">📥 INPUT</h4>
          <div class="input-group">
            <label>น้ำดื่ม (mL):</label>
            <input type="number" id="inputWater" placeholder="0">
          </div>
          <div class="input-group">
            <label>น้ำเกลือ IV (mL):</label>
            <input type="number" id="inputIV" placeholder="0">
          </div>
        </div>
        <div>
          <h4 style="color: #ef4444; margin-bottom: 15px;">📤 OUTPUT</h4>
          <div class="input-group">
            <label>ปัสสาวะ (mL):</label>
            <input type="number" id="outputUrine" placeholder="0">
          </div>
          <div class="input-group">
            <label>อาเจียน (mL):</label>
            <input type="number" id="outputVomit" placeholder="0">
          </div>
        </div>
      </div>
      <button class="btn btn-primary" onclick="saveIO()">💾 บันทึก I/O</button>
      <button class="btn btn-secondary" onclick="closeModal('ioModal')">ยกเลิก</button>
    </div>
  </div>

  <!-- Calculator Modal -->
  <div class="modal" id="calcModal">
    <div class="modal-content">
      <h3>🧮 เครื่องคำนวณน้ำเกลือ</h3>
      <div class="input-group">
        <label>ปริมาตร (mL):</label>
        <input type="number" id="calcVolume" placeholder="1000">
      </div>
      <div class="input-group">
        <label>อัตราที่ต้องการ (ดรอป/นาที):</label>
        <input type="number" id="calcRate" placeholder="30">
      </div>
      <div class="input-group">
        <label>Drop Factor:</label>
        <select id="dropFactor">
          <option value="20">20 หยด/cc (มาตรฐาน)</option>
          <option value="15">15 หยด/cc</option>
          <option value="60">60 หยด/cc (Micro)</option>
        </select>
      </div>
      <button class="btn btn-primary" onclick="calculateFlow()">🧮 คำนวณ</button>
      <button class="btn btn-secondary" onclick="closeModal('calcModal')">ยกเลิก</button>
      <div id="calcResult" style="margin-top: 20px; padding: 20px; background: linear-gradient(135deg, #f0f9ff, #e0f2fe); border-radius: 12px; display: none; border: 2px solid #0ea5e9;"></div>
    </div>
  </div>

  <!-- Reset Modal -->
  <div class="modal" id="resetModal">
    <div class="modal-content">
      <h3 style="color: #ef4444;">⚠️ ยืนยันการลบข้อมูล</h3>
      <p style="margin-bottom: 20px; color: #64748b;">คุณต้องการลบข้อมูลทั้งหมดในระบบใช่หรือไม่? การกระทำนี้ไม่สามารถย้อนกลับได้</p>
      <button class="btn btn-danger" onclick="resetAllData()">🗑️ ลบทั้งหมด</button>
      <button class="btn btn-secondary" onclick="closeModal('resetModal')">ยกเลิก</button>
    </div>
  </div>

  <script>
    let currentUser = null;
    let bedsData = {};

    document.addEventListener('DOMContentLoaded', function() {
      initializeApp();
    });

    function initializeApp() {
      currentUser = JSON.parse(sessionStorage.getItem('currentUser') || 'null');
      if (!currentUser) {
        window.location.href = 'index.html';
        return;
      }

      document.getElementById('userInfo').textContent = `👤 ${currentUser.fullname} (${currentUser.role})`;

      if (currentUser.role === 'admin') {
        document.getElementById('adminControls').style.display = 'flex';
      }

      setTimeout(() => {
        loadBedsData();
        updateSummary();
        setupBedSelectors();
      }, 500);
    }

    function loadBedsData() {
      const bedsGrid = document.getElementById('bedsGrid');
      bedsGrid.innerHTML = '';

      for (let i = 1; i <= 8; i++) {
        const bedData = JSON.parse(localStorage.getItem(`ir_data_bed_${i}`) || 'null');
        const notes = JSON.parse(localStorage.getItem(`nurseNotes_${i}`) || '[]');
        const ioRecords = JSON.parse(localStorage.getItem(`io_records_bed_${i}`) || '[]');

        bedsData[i] = {
          patientData: bedData,
          notesCount: notes.length,
          ioCount: ioRecords.length,
          lastUpdate: bedData ? new Date(bedData.timestamp).toLocaleString('th-TH') : null
        };

        const bedCard = createBedCard(i, bedsData[i]);
        bedsGrid.appendChild(bedCard);
      }
    }

    function createBedCard(bedNumber, data) {
      const card = document.createElement('a');
      card.href = `chart.html?bed=${bedNumber}`;
      card.className = 'bed-card';

      const statusClass = data.patientData ? 'active' : 'inactive';
      const statusText = data.patientData ? 'ออนไลน์' : 'ว่าง';

      if (!data.patientData) {
        // เตียงว่าง
        card.innerHTML = `
          <div class="bed-header">
            <div class="bed-number">
              <div class="bed-icon">🛏️</div>
              เตียง ${bedNumber}
            </div>
            <div class="status-indicator">
              <div class="status-dot ${statusClass}"></div>
              <div class="status-text">${statusText}</div>
            </div>
          </div>
          <div class="bed-content">
            <div class="empty-bed">
              <div class="empty-bed-icon">➕</div>
              <div class="empty-bed-title">พร้อมรับผู้ป่วย</div>
              <div class="empty-bed-desc">คลิกเพื่อเพิ่มผู้ป่วยใหม่</div>
            </div>
            <div class="last-update">
              เตียงว่าง - พร้อมใช้งาน
            </div>
          </div>
        `;
        return card;
      }

      // จำลองข้อมูลการวัดจริง
      const actualRate = Math.floor(data.patientData.rate * (0.9 + Math.random() * 0.2));
      const variance = actualRate - data.patientData.rate;
      const variancePercent = ((variance / data.patientData.rate) * 100).toFixed(1);
      const varianceColor = Math.abs(variance) <= 2 ? '#22c55e' : Math.abs(variance) <= 5 ? '#f59e0b' : '#ef4444';
      
      // ปรับสถานะดอทตามความเบี่ยงเบน
      const dotStatusClass = Math.abs(variance) <= 2 ? 'active' : Math.abs(variance) <= 5 ? 'warning' : 'error';

      card.innerHTML = `
        <div class="bed-header">
          <div class="bed-number">
            <div class="bed-icon">🛏️</div>
            เตียง ${bedNumber}
          </div>
          <div class="status-indicator">
            <div class="status-dot ${dotStatusClass}"></div>
            <div class="status-text">${statusText}</div>
          </div>
        </div>
        
        <div class="bed-content">
          <div class="flow-rate-section">
            <div class="flow-rate">${data.patientData.rate}</div>
            <div class="flow-rate-label">ดรอป/นาที</div>
          </div>

          <div class="patient-info">
            <div class="patient-info-row">
              <div class="patient-info-label">👤 รหัส</div>
              <div class="patient-info-value">${data.patientData.patient_id}</div>
            </div>
            <div class="patient-info-row">
              <div class="patient-info-label">💊 ยา</div>
              <div class="patient-info-value">${data.patientData.medication}</div>
            </div>
            <div class="patient-info-row">
              <div class="patient-info-label">💧 ปริมาณ</div>
              <div class="patient-info-value">${data.patientData.volume} mL</div>
            </div>
          </div>

          <div class="comparison-section">
            <div class="comparison-header">
              📊 เปรียบเทียบอัตราการไหล
            </div>
            <div class="comparison-grid">
              <div class="comparison-item">
                <div class="comparison-label">สั่ง</div>
                <div class="comparison-value">${data.patientData.rate}</div>
              </div>
              <div class="comparison-item">
                <div class="comparison-label">วัดได้</div>
                <div class="comparison-value" style="color: ${varianceColor};">${actualRate}</div>
              </div>
            </div>
            <div class="variance-indicator" style="color: ${varianceColor};">
              ส่วนต่าง: ${variance > 0 ? '+' : ''}${variance} ดรอป/นาที (${variancePercent > 0 ? '+' : ''}${variancePercent}%)
            </div>
          </div>

          <div class="stats-row">
            <div class="stat-mini">
              <div class="stat-mini-value">${data.notesCount}</div>
              <div class="stat-mini-label">📝 บันทึก</div>
            </div>
            <div class="stat-mini">
              <div class="stat-mini-value">${data.ioCount}</div>
              <div class="stat-mini-label">💧 I/O</div>
            </div>
            <div class="stat-mini">
              <div class="stat-mini-value" style="color: ${Math.abs(variance) <= 2 ? '#22c55e' : '#ef4444'};">
                ${Math.abs(variance) <= 2 ? '✓' : '⚠'}
              </div>
              <div class="stat-mini-label">สถานะ</div>
            </div>
          </div>

          <div class="last-update">
            🕒 อัพเดทล่าสุด: ${data.lastUpdate || 'ไม่มีข้อมูล'}
          </div>
        </div>
      `;

      return card;
    }

    function updateSummary() {
      let activeBeds = 0;
      let totalNotes = 0;
      let alertCount = 0;
      let totalIORecords = 0;
      let totalVitals = 0;
      let totalMedications = 0;

      for (let i = 1; i <= 8; i++) {
        if (bedsData[i] && bedsData[i].patientData) {
          activeBeds++;
        }

        totalNotes += bedsData[i] ? bedsData[i].notesCount : 0;
        totalIORecords += bedsData[i] ? bedsData[i].ioCount : 0;

        // นับ Vital Signs
        const vitals = JSON.parse(localStorage.getItem(`vitals_bed_${i}`) || 'null');
        if (vitals) totalVitals++;

        // นับ Medications
        const medications = JSON.parse(localStorage.getItem(`medications_bed_${i}`) || '[]');
        totalMedications += medications.length;

        // ตรวจสอบ Alerts
        if (vitals) {
          if (vitals.systolic > 140 || vitals.diastolic > 90) alertCount++;
          if (vitals.heartRate > 100 || vitals.heartRate < 60) alertCount++;
          if (vitals.temperature > 37.5) alertCount++;
          if (vitals.oxygen < 95) alertCount++;
        }
      }

      document.getElementById('totalBeds').textContent = activeBeds;
      document.getElementById('totalNotes').textContent = totalNotes;
      document.getElementById('totalIORecords').textContent = totalIORecords;
      document.getElementById('totalVitals').textContent = totalVitals;
      document.getElementById('totalMedications').textContent = totalMedications;
      document.getElementById('alertCount').textContent = alertCount;

      // อัพเดทสถานะ Alert
      const alertDetail = document.getElementById('alertDetail');
      if (alertCount > 0) {
        alertDetail.textContent = `ต้องตรวจสอบ ${alertCount} รายการ`;
        alertDetail.style.color = '#ef4444';
      } else {
        alertDetail.textContent = 'ไม่มีการแจ้งเตือน';
        alertDetail.style.color = '#22c55e';
      }
    }

    // เพิ่มฟังก์ชันที่ขาดหายไป
    function setupBedSelectors() {
      const bedSelect = document.getElementById('bedSelect');
      const ioBedSelect = document.getElementById('ioBedSelect');
      
      if (bedSelect) {
        bedSelect.innerHTML = '<option value="">เลือกเตียง</option>';
        for (let i = 1; i <= 8; i++) {
          bedSelect.innerHTML += `<option value="${i}">เตียง ${i}</option>`;
        }
      }
      
      if (ioBedSelect) {
        ioBedSelect.innerHTML = '<option value="">เลือกเตียง</option>';
        for (let i = 1; i <= 8; i++) {
          const bedData = JSON.parse(localStorage.getItem(`ir_data_bed_${i}`) || 'null');
          if (bedData) {
            ioBedSelect.innerHTML += `<option value="${i}">เตียง ${i} - ${bedData.patient_id}</option>`;
          }
        }
      }
    }

    function showQuickAdd() {
      setupBedSelectors();
      document.getElementById('quickAddModal').style.display = 'flex';
    }

    function showIOEntry() {
      setupBedSelectors();
      document.getElementById('ioModal').style.display = 'flex';
    }

    function showQuickCalc() {
      document.getElementById('calcModal').style.display = 'flex';
    }

    function closeModal(modalId) {
      document.getElementById(modalId).style.display = 'none';
    }

    function savePatient() {
      const bedNum = document.getElementById('bedSelect').value;
      const patientId = document.getElementById('patientId').value;
      const medication = document.getElementById('medication').value;
      const volume = document.getElementById('volume').value;
      const rate = document.getElementById('rate').value;

      if (!bedNum || !patientId || !volume || !rate) {
        alert('กรุณากรอกข้อมูลให้ครบถ้วน');
        return;
      }

      const data = {
        patient_id: patientId,
        medication: medication,
        volume: volume,
        rate: rate,
        timestamp: new Date().toISOString()
      };

      localStorage.setItem(`ir_data_bed_${bedNum}`, JSON.stringify(data));
      closeModal('quickAddModal');
      alert('✅ บันทึกข้อมูลเรียบร้อย');
      
      // รีเฟรชข้อมูล
      loadBedsData();
      updateSummary();
      
      // ไปที่หน้าเตียง
      setTimeout(() => {
        window.location.href = `chart.html?bed=${bedNum}`;
      }, 500);
    }

    function saveIO() {
      const bedNum = document.getElementById('ioBedSelect').value;
      const inputWater = parseFloat(document.getElementById('inputWater').value) || 0;
      const inputIV = parseFloat(document.getElementById('inputIV').value) || 0;
      const outputUrine = parseFloat(document.getElementById('outputUrine').value) || 0;
      const outputVomit = parseFloat(document.getElementById('outputVomit').value) || 0;

      if (!bedNum) {
        alert('กรุณาเลือกเตียง');
        return;
      }

      const totalIn = inputWater + inputIV;
      const totalOut = outputUrine + outputVomit;
      const balance = totalIn - totalOut;

      const ioRecord = {
        time: new Date().toLocaleString('th-TH'),
        inputWater: inputWater,
        inputIV: inputIV,
        outputUrine: outputUrine,
        outputVomit: outputVomit,
        totalIn: totalIn,
        totalOut: totalOut,
        balance: balance,
        nurse: currentUser.fullname
      };

      const existingRecords = JSON.parse(localStorage.getItem(`io_records_bed_${bedNum}`) || '[]');
      existingRecords.push(ioRecord);
      localStorage.setItem(`io_records_bed_${bedNum}`, JSON.stringify(existingRecords));

      closeModal('ioModal');
      alert('✅ บันทึก I/O เรียบร้อย');
      
      // รีเฟรชข้อมูล
      loadBedsData();
      updateSummary();
    }

    function calculateFlow() {
      const volume = parseFloat(document.getElementById('calcVolume').value) || 0;
      const rate = parseFloat(document.getElementById('calcRate').value) || 0;
      const dropFactor = parseFloat(document.getElementById('dropFactor').value) || 20;

      if (!volume || !rate) {
        alert('กรุณากรอกข้อมูลให้ครบถ้วน');
        return;
      }

      const ccPerHr = (rate * 60) / dropFactor;
      const timeToFinish = volume / ccPerHr;
      const finishTime = new Date(Date.now() + (timeToFinish * 60 * 60 * 1000));

      const resultDiv = document.getElementById('calcResult');
      resultDiv.innerHTML = `
        <h4>📊 ผลการคำนวณ</h4>
        <div style="margin: 15px 0;">
          <strong>อัตราการไหล:</strong> ${ccPerHr.toFixed(1)} cc/hr
        </div>
        <div style="margin: 15px 0;">
          <strong>เวลาที่จะหมด:</strong> ${timeToFinish.toFixed(1)} ชั่วโมง
        </div>
        <div style="margin: 15px 0;">
          <strong>เวลาที่คาดว่าจะหมด:</strong> ${finishTime.toLocaleString('th-TH')}
        </div>
      `;
      resultDiv.style.display = 'block';
    }

    function showActiveBedsDetails() {
      const modal = document.createElement('div');
      modal.className = 'modal';
      modal.style.display = 'flex';

      let bedsHTML = '';
      let count = 0;

      for (let i = 1; i <= 8; i++) {
        if (bedsData[i] && bedsData[i].patientData) {
          count++;
          const data = bedsData[i].patientData;
          
          // ข้อมูลเปรียบเทียบ (จำลองข้อมูลวัดจริง)
          const actualRate = Math.floor(data.rate * (0.9 + Math.random() * 0.2)); // จำลองค่าวัดจริง ±10%
          const variance = actualRate - data.rate;
          const variancePercent = ((variance / data.rate) * 100).toFixed(1);
          
          const statusColor = Math.abs(variance) <= 2 ? '#22c55e' : Math.abs(variance) <= 5 ? '#f59e0b' : '#ef4444';
          const statusText = Math.abs(variance) <= 2 ? 'ปกติ' : Math.abs(variance) <= 5 ? 'เฝ้าระวัง' : 'ต้องตรวจสอบ';

          bedsHTML += `
            <div style="
              background: white;
              border-radius: 15px;
              padding: 20px;
              margin: 12px 0;
              border: 2px solid ${statusColor};
              box-shadow: 0 4px 15px rgba(0,0,0,0.1);
              transition: all 0.3s ease;
            ">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <h4 style="color: #1e293b; margin: 0; font-size: 18px;">🛏️ เตียง ${i}</h4>
                <div style="
                  background: ${statusColor};
                  color: white;
                  padding: 6px 12px;
                  border-radius: 20px;
                  font-size: 12px;
                  font-weight: 600;
                ">${statusText}</div>
              </div>

              <div style="background: linear-gradient(135deg, #f8fafc, #f1f5f9); padding: 15px; border-radius: 10px; margin-bottom: 15px;">
                <div style="font-weight: 600; color: #1e293b; margin-bottom: 8px;">👤 ${data.patient_id}</div>
                <div style="color: #64748b; font-size: 14px;">💊 ${data.medication}</div>
                <div style="color: #64748b; font-size: 14px;">💧 ${data.volume} mL</div>
              </div>

              <div style="
                background: linear-gradient(135deg, #e0f2fe, #bae6fd);
                padding: 15px;
                border-radius: 10px;
                border-left: 4px solid #0ea5e9;
              ">
                <div style="font-size: 14px; font-weight: 600; color: #0c4a6e; margin-bottom: 10px;">📊 เปรียบเทียบอัตราการไหล</div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 10px;">
                  <div>
                    <div style="font-size: 12px; color: #0369a1;">อัตราที่สั่ง</div>
                    <div style="font-size: 18px; font-weight: 700; color: #0ea5e9;">${data.rate} ดรอป/นาที</div>
                  </div>
                  <div>
                    <div style="font-size: 12px; color: #0369a1;">อัตราที่วัดได้</div>
                    <div style="font-size: 18px; font-weight: 700; color: ${statusColor};">${actualRate} ดรอป/นาที</div>
                  </div>
                </div>

                <div style="
                  background: rgba(255,255,255,0.8);
                  padding: 10px;
                  border-radius: 8px;
                  display: flex;
                  justify-content: space-between;
                  align-items: center;
                ">
                  <span style="font-size: 12px; color: #0369a1;">ส่วนต่าง:</span>
                  <span style="font-size: 14px; font-weight: 600; color: ${statusColor};">
                    ${variance > 0 ? '+' : ''}${variance} ดรอป/นาที (${variancePercent > 0 ? '+' : ''}${variancePercent}%)
                  </span>
                </div>
              </div>

              <div style="margin-top: 12px; font-size: 11px; color: #64748b; text-align: right;">
                อัพเดทล่าสุด: ${bedsData[i].lastUpdate}
              </div>
            </div>
          `;
        }
      }

      if (count === 0) {
        bedsHTML = `
          <div style="
            text-align: center;
            padding: 40px 20px;
            color: #64748b;
            font-style: italic;
            background: linear-gradient(135deg, #f8fafc, #f1f5f9);
            border-radius: 15px;
            border: 2px dashed #cbd5e1;
          ">
            <div style="font-size: 48px; margin-bottom: 15px;">🏥</div>
            <div style="font-size: 18px; font-weight: 600; margin-bottom: 8px;">ไม่มีเตียงที่ใช้งาน</div>
            <div style="font-size: 14px;">ทุกเตียงพร้อมรับผู้ป่วยใหม่</div>
          </div>
        `;
      }

      modal.innerHTML = `
        <div class="modal-content" style="max-width: 600px; max-height: 90vh; overflow-y: auto;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; position: sticky; top: 0; background: white; z-index: 10; padding-bottom: 15px; border-bottom: 2px solid #f1f5f9;">
            <h3 style="margin: 0; color: #1e293b;">🛏️ เตียงที่ใช้งาน (${count} เตียง)</h3>
            <button onclick="this.closest('.modal').remove()" style="
              background: #ef4444;
              color: white;
              border: none;
              padding: 8px 12px;
              border-radius: 8px;
              cursor: pointer;
              font-size: 16px;
              transition: all 0.3s ease;
            ">✕</button>
          </div>
          
          <div style="max-height: 500px; overflow-y: auto;">
            ${bedsHTML}
          </div>

          <div style="margin-top: 20px; text-align: center; position: sticky; bottom: 0; background: white; padding-top: 15px; border-top: 2px solid #f1f5f9;">
            <button class="btn btn-primary" onclick="this.closest('.modal').remove()">ปิด</button>
          </div>
        </div>
      `;

      document.body.appendChild(modal);
    }

    function showNotesHistory() {
      let allNotes = [];

      for (let i = 1; i <= 8; i++) {
        const notes = JSON.parse(localStorage.getItem(`nurseNotes_${i}`) || '[]');
        notes.forEach(note => {
          allNotes.push({
            bed: i,
            ...note
          });
        });
      }

      allNotes.sort((a, b) => new Date(b.time) - new Date(a.time));

      const modal = document.createElement('div');
      modal.className = 'modal';
      modal.style.display = 'flex';

      let notesHTML = '';
      if (allNotes.length > 0) {
        allNotes.slice(0, 15).forEach((note, index) => {
          notesHTML += `
            <div style="
              background: white;
              border-radius: 12px;
              padding: 18px;
              margin: 10px 0;
              border-left: 4px solid #0ea5e9;
              box-shadow: 0 2px 8px rgba(0,0,0,0.1);
              transition: all 0.3s ease;
            ">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                <div style="
                  background: linear-gradient(135deg, #0ea5e9, #0284c7);
                  color: white;
                  padding: 4px 12px;
                  border-radius: 15px;
                  font-size: 12px;
                  font-weight: 600;
                ">🛏️ เตียง ${note.bed}</div>
                <div style="font-size: 11px; color: #64748b;">${note.time}</div>
              </div>
              
              <div style="
                background: linear-gradient(135deg, #f8fafc, #f1f5f9);
                padding: 12px;
                border-radius: 8px;
                margin-bottom: 10px;
                line-height: 1.5;
                color: #1e293b;
              ">
                ${note.content}
              </div>
              
              <div style="text-align: right; font-size: 11px; color: #64748b;">
                👤 ${note.author}
              </div>
            </div>
          `;
        });
      } else {
        notesHTML = `
          <div style="
            text-align: center;
            padding: 40px 20px;
            color: #64748b;
            font-style: italic;
            background: linear-gradient(135deg, #f8fafc, #f1f5f9);
            border-radius: 15px;
            border: 2px dashed #cbd5e1;
          ">
            <div style="font-size: 48px; margin-bottom: 15px;">📝</div>
            <div style="font-size: 18px; font-weight: 600; margin-bottom: 8px;">ยังไม่มีบันทึก</div>
            <div style="font-size: 14px;">เริ่มเพิ่มบันทึกการดูแลผู้ป่วย</div>
          </div>
        `;
      }

      modal.innerHTML = `
        <div class="modal-content" style="max-width: 700px; max-height: 90vh; overflow-y: auto;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; position: sticky; top: 0; background: white; z-index: 10; padding-bottom: 15px; border-bottom: 2px solid #f1f5f9;">
            <h3 style="margin: 0; color: #1e293b;">📝 บันทึกล่าสุด (${allNotes.length} รายการ)</h3>
            <button onclick="this.closest('.modal').remove()" style="
              background: #ef4444;
              color: white;
              border: none;
              padding: 8px 12px;
              border-radius: 8px;
              cursor: pointer;
              font-size: 16px;
              transition: all 0.3s ease;
            ">✕</button>
          </div>
          
          <div style="max-height: 500px; overflow-y: auto;">
            ${notesHTML}
          </div>

          <div style="margin-top: 20px; text-align: center; position: sticky; bottom: 0; background: white; padding-top: 15px; border-top: 2px solid #f1f5f9;">
            <button class="btn btn-primary" onclick="this.closest('.modal').remove()">ปิด</button>
          </div>
        </div>
      `;

      document.body.appendChild(modal);
    }

    function showIOSummary() {
      let totalInput = 0;
      let totalOutput = 0;
      let recordCount = 0;
      let bedSummaries = [];

      for (let i = 1; i <= 8; i++) {
        const ioRecords = JSON.parse(localStorage.getItem(`io_records_bed_${i}`) || '[]');
        const patientData = JSON.parse(localStorage.getItem(`ir_data_bed_${i}`) || 'null');
        
        let bedInput = 0;
        let bedOutput = 0;
        
        ioRecords.forEach(record => {
          bedInput += record.totalIn || 0;
          bedOutput += record.totalOut || 0;
          totalInput += record.totalIn || 0;
          totalOutput += record.totalOut || 0;
          recordCount++;
        });

        if (ioRecords.length > 0) {
          const bedBalance = bedInput - bedOutput;
          bedSummaries.push({
            bed: i,
            patient: patientData ? patientData.patient_id : 'ไม่ทราบ',
            input: bedInput,
            output: bedOutput,
            balance: bedBalance,
            recordCount: ioRecords.length
          });
        }
      }

      const totalBalance = totalInput - totalOutput;

      const modal = document.createElement('div');
      modal.className = 'modal';
      modal.style.display = 'flex';

      let bedsHTML = '';
      if (bedSummaries.length > 0) {
        bedSummaries.forEach(bed => {
          const balanceColor = bed.balance >= 0 ? '#22c55e' : '#ef4444';
          bedsHTML += `
            <div style="
              background: white;
              border-radius: 12px;
              padding: 18px;
              margin: 10px 0;
              border-left: 4px solid ${balanceColor};
              box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            ">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <div style="font-weight: 600; color: #1e293b;">🛏️ เตียง ${bed.bed}</div>
                <div style="
                  background: ${balanceColor};
                  color: white;
                  padding: 4px 12px;
                  border-radius: 15px;
                  font-size: 12px;
                  font-weight: 600;
                ">${bed.recordCount} บันทึก</div>
              </div>
              
              <div style="font-size: 14px; color: #64748b; margin-bottom: 15px;">
                👤 ${bed.patient}
              </div>

              <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px;">
                <div style="text-align: center; background: linear-gradient(135deg, #ecfdf5, #d1fae5); padding: 12px; border-radius: 8px;">
                  <div style="font-size: 16px; font-weight: 700; color: #22c55e;">${bed.input}</div>
                  <div style="font-size: 11px; color: #166534;">INPUT (mL)</div>
                </div>
                <div style="text-align: center; background: linear-gradient(135deg, #fef2f2, #fee2e2); padding: 12px; border-radius: 8px;">
                  <div style="font-size: 16px; font-weight: 700; color: #ef4444;">${bed.output}</div>
                  <div style="font-size: 11px; color: #991b1b;">OUTPUT (mL)</div>
                </div>
                <div style="text-align: center; background: linear-gradient(135deg, #f8fafc, #f1f5f9); padding: 12px; border-radius: 8px;">
                  <div style="font-size: 16px; font-weight: 700; color: ${balanceColor};">
                    ${bed.balance > 0 ? '+' : ''}${bed.balance}
                  </div>
                  <div style="font-size: 11px; color: #64748b;">BALANCE (mL)</div>
                </div>
              </div>
            </div>
          `;
        });
      } else {
        bedsHTML = `
          <div style="
            text-align: center;
            padding: 40px 20px;
            color: #64748b;
            font-style: italic;
            background: linear-gradient(135deg, #f8fafc, #f1f5f9);
            border-radius: 15px;
            border: 2px dashed #cbd5e1;
          ">
            <div style="font-size: 48px; margin-bottom: 15px;">💧</div>
            <div style="font-size: 18px; font-weight: 600; margin-bottom: 8px;">ยังไม่มีบันทึก I/O</div>
            <div style="font-size: 14px;">เริ่มบันทึกสารน้ำเข้า-ออก</div>
          </div>
        `;
      }

      const balanceColor = totalBalance >= 0 ? '#22c55e' : '#ef4444';

      modal.innerHTML = `
        <div class="modal-content" style="max-width: 700px; max-height: 90vh; overflow-y: auto;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; position: sticky; top: 0; background: white; z-index: 10; padding-bottom: 15px; border-bottom: 2px solid #f1f5f9;">
            <h3 style="margin: 0; color: #1e293b;">💧 สรุป I/O ระบบ</h3>
            <button onclick="this.closest('.modal').remove()" style="
              background: #ef4444;
              color: white;
              border: none;
              padding: 8px 12px;
              border-radius: 8px;
              cursor: pointer;
              font-size: 16px;
              transition: all 0.3s ease;
            ">✕</button>
          </div>

          <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 25px;">
            <div style="background: linear-gradient(135deg, #ecfdf5, #d1fae5); padding: 20px; border-radius: 12px; text-align: center;">
              <div style="font-size: 24px; font-weight: 700; color: #22c55e;">${totalInput}</div>
              <div style="font-size: 12px; color: #166534;">INPUT รวม (mL)</div>
            </div>
            <div style="background: linear-gradient(135deg, #fef2f2, #fee2e2); padding: 20px; border-radius: 12px; text-align: center;">
              <div style="font-size: 24px; font-weight: 700; color: #ef4444;">${totalOutput}</div>
              <div style="font-size: 12px; color: #991b1b;">OUTPUT รวม (mL)</div>
            </div>
            <div style="background: linear-gradient(135deg, #f8fafc, #f1f5f9); padding: 20px; border-radius: 12px; text-align: center;">
              <div style="font-size: 24px; font-weight: 700; color: ${balanceColor};">
                ${totalBalance > 0 ? '+' : ''}${totalBalance}
              </div>
              <div style="font-size: 12px; color: #64748b;">BALANCE รวม (mL)</div>
            </div>
          </div>
          
          <div style="max-height: 400px; overflow-y: auto;">
            ${bedsHTML}
          </div>

          <div style="margin-top: 20px; text-align: center; position: sticky; bottom: 0; background: white; padding-top: 15px; border-top: 2px solid #f1f5f9;">
            <div style="font-size: 12px; color: #64748b; margin-bottom: 10px;">
              รายการทั้งหมด: ${recordCount} บันทึก
            </div>
            <button class="btn btn-primary" onclick="this.closest('.modal').remove()">ปิด</button>
          </div>
        </div>
      `;

      document.body.appendChild(modal);
    }

    function showVitalsSummary() {
      let details = 'สรุป Vital Signs:\n\n';
      let count = 0;

      for (let i = 1; i <= 8; i++) {
        const vitals = JSON.parse(localStorage.getItem(`vitals_bed_${i}`) || 'null');
        if (vitals) {
          count++;
          details += `เตียง ${i}:\n`;
          details += `BP: ${vitals.systolic}/${vitals.diastolic}\n`;
          details += `HR: ${vitals.heartRate} bpm\n`;
          details += `Temp: ${vitals.temperature}°C\n`;
          details += `O2: ${vitals.oxygen}%\n\n`;
        }
      }

      if (count === 0) {
        details += 'ไม่มีข้อมูล Vital Signs';
      }

      alert(details);
    }

    function showMedicationSummary() {
      let details = 'กำหนดการยา:\n\n';
      let totalMeds = 0;

      for (let i = 1; i <= 8; i++) {
        const medications = JSON.parse(localStorage.getItem(`medications_bed_${i}`) || '[]');
        if (medications.length > 0) {
          details += `เตียง ${i}:\n`;
          medications.forEach(med => {
            details += `- ${med.name} ${med.dose} เวลา ${med.time}\n`;
            totalMeds++;
          });
          details += '\n';
        }
      }

      if (totalMeds === 0) {
        details += 'ไม่มีกำหนดการยา';
      } else {
        details = `ยาทั้งหมด: ${totalMeds} รายการ\n\n` + details;
      }

      alert(details);
    }

    function showAlertsDetails() {
      let alerts = [];

      for (let i = 1; i <= 8; i++) {
        const vitals = JSON.parse(localStorage.getItem(`vitals_bed_${i}`) || 'null');
        const patientData = JSON.parse(localStorage.getItem(`ir_data_bed_${i}`) || 'null');

        if (vitals) {
          if (vitals.systolic > 140 || vitals.diastolic > 90) {
            alerts.push(`เตียง ${i}: ความดันโลหิตสูง (${vitals.systolic}/${vitals.diastolic})`);
          }
          if (vitals.heartRate > 100 || vitals.heartRate < 60) {
            alerts.push(`เตียง ${i}: อัตราการเต้นของหัวใจผิดปกติ (${vitals.heartRate})`);
          }
          if (vitals.temperature > 37.5) {
            alerts.push(`เตียง ${i}: มีไข้ (${vitals.temperature}°C)`);
          }
          if (vitals.oxygen < 95) {
            alerts.push(`เตียง ${i}: ออกซิเจนต่ำ (${vitals.oxygen}%)`);
          }
        }
      }

      let details = alerts.length > 0 ? 
        `การแจ้งเตือน (${alerts.length} รายการ):\n\n${alerts.join('\n')}` :
        'ไม่มีการแจ้งเตือน';

      alert(details);
    }

    function openSummaryModal() {
      // สร้าง modal สรุปรายงานรายเตียง
      const modal = document.createElement('div');
      modal.className = 'modal';
      modal.style.display = 'flex';

      let bedsInfo = [];
      let totalActive = 0;
      let totalCritical = 0;

      // เก็บข้อมูลแต่ละเตียง
      for (let i = 1; i <= 8; i++) {
        const patientData = JSON.parse(localStorage.getItem(`ir_data_bed_${i}`) || 'null');
        const vitals = JSON.parse(localStorage.getItem(`vitals_bed_${i}`) || 'null');
        const medications = JSON.parse(localStorage.getItem(`medications_bed_${i}`) || '[]');
        const ioRecords = JSON.parse(localStorage.getItem(`io_records_bed_${i}`) || '[]');
        const notes = JSON.parse(localStorage.getItem(`nurseNotes_${i}`) || '[]');

        let ioBalance = 0;
        ioRecords.forEach(record => {
          ioBalance += record.balance || 0;
        });

        let status = 'ว่าง';
        let statusColor = '#94a3b8';
        let alerts = [];

        if (patientData) {
          totalActive++;
          status = 'ใช้งาน';
          statusColor = '#22c55e';

          if (vitals) {
            if (vitals.systolic > 160 || vitals.diastolic > 100) {
              alerts.push('ความดันสูงมาก');
              statusColor = '#ef4444';
            }
            if (vitals.heartRate > 120 || vitals.heartRate < 50) {
              alerts.push('ชีพจรผิดปกติ');
              statusColor = '#ef4444';
            }
            if (vitals.temperature > 38.5) {
              alerts.push('ไข้สูง');
              statusColor = '#ef4444';
            }
            if (vitals.oxygen < 90) {
              alerts.push('ออกซิเจนต่ำมาก');
              statusColor = '#ef4444';
            }
          }

          if (alerts.length > 0) {
            totalCritical++;
          }
        }

        bedsInfo.push({
          bedNumber: i,
          patient: patientData,
          vitals: vitals,
          medicationCount: medications.length,
          ioBalance: ioBalance,
          notesCount: notes.length,
          status: status,
          statusColor: statusColor,
          alerts: alerts
        });
      }

      // สร้าง HTML สำหรับแต่ละเตียง
      let bedsHTML = '';
      bedsInfo.forEach(bed => {
        bedsHTML += `
          <div class="bed-summary-card" style="
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin: 10px 0;
            border: 2px solid ${bed.statusColor};
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
          ">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
              <h4 style="color: #1e293b; margin: 0;">🛏️ เตียง ${bed.bedNumber}</h4>
              <div style="
                background: ${bed.statusColor};
                color: white;
                padding: 6px 12px;
                border-radius: 20px;
                font-size: 12px;
                font-weight: 600;
              ">${bed.status}</div>
            </div>

            ${bed.patient ? `
              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                <div>
                  <div style="font-size: 12px; color: #64748b;">รหัสผู้ป่วย</div>
                  <div style="font-weight: 600; color: #1e293b;">${bed.patient.patient_id}</div>
                </div>
                <div>
                  <div style="font-size: 12px; color: #64748b;">ยา</div>
                  <div style="font-weight: 600; color: #1e293b;">${bed.patient.medication}</div>
                </div>
                <div>
                  <div style="font-size: 12px; color: #64748b;">อัตรา</div>
                  <div style="font-weight: 600; color: #0ea5e9;">${bed.patient.rate} ดรอป/นาที</div>
                </div>
                <div>
                  <div style="font-size: 12px; color: #64748b;">ปริมาณ</div>
                  <div style="font-weight: 600; color: #0ea5e9;">${bed.patient.volume} mL</div>
                </div>
              </div>

              ${bed.vitals ? `
                <div style="
                  background: linear-gradient(135deg, #fef3c7, #fde68a);
                  padding: 12px;
                  border-radius: 8px;
                  margin-bottom: 15px;
                ">
                  <div style="font-size: 12px; font-weight: 600; color: #92400e; margin-bottom: 8px;">🩺 Vital Signs</div>
                  <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; font-size: 11px;">
                    <div>BP: <strong>${bed.vitals.systolic}/${bed.vitals.diastolic}</strong></div>
                    <div>HR: <strong>${bed.vitals.heartRate}</strong> bpm</div>
                    <div>Temp: <strong>${bed.vitals.temperature}</strong>°C</div>
                    <div>O2: <strong>${bed.vitals.oxygen}</strong>%</div>
                  </div>
                </div>
              ` : ''}

              <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 15px;">
                <div style="text-align: center; background: #f8fafc; padding: 8px; border-radius: 6px;">
                  <div style="font-size: 16px; font-weight: 700; color: #0ea5e9;">${bed.medicationCount}</div>
                  <div style="font-size: 10px; color: #64748b;">ยา</div>
                </div>
                <div style="text-align: center; background: #f8fafc; padding: 8px; border-radius: 6px;">
                  <div style="font-size: 16px; font-weight: 700; color: ${bed.ioBalance >= 0 ? '#22c55e' : '#ef4444'};">
                    ${bed.ioBalance > 0 ? '+' : ''}${bed.ioBalance}
                  </div>
                  <div style="font-size: 10px; color: #64748b;">I/O Balance</div>
                </div>
                <div style="text-align: center; background: #f8fafc; padding: 8px; border-radius: 6px;">
                  <div style="font-size: 16px; font-weight: 700; color: #8b5cf6;">${bed.notesCount}</div>
                  <div style="font-size: 10px; color: #64748b;">บันทึก</div>
                </div>
              </div>

              ${bed.alerts.length > 0 ? `
                <div style="
                  background: linear-gradient(135deg, #fef2f2, #fee2e2);
                  border: 1px solid #ef4444;
                  padding: 10px;
                  border-radius: 8px;
                ">
                  <div style="font-size: 12px; font-weight: 600; color: #991b1b; margin-bottom: 5px;">⚠️ การแจ้งเตือน</div>
                  <div style="font-size: 11px; color: #991b1b;">
                    ${bed.alerts.join(', ')}
                  </div>
                </div>
              ` : ''}
            ` : `
              <div style="
                text-align: center;
                padding: 20px;
                color: #64748b;
                font-style: italic;
                background: #f8fafc;
                border-radius: 8px;
              ">
                เตียงว่าง - พร้อมรับผู้ป่วย
              </div>
            `}
          </div>
        `;
      });

      modal.innerHTML = `
        <div class="modal-content" style="max-width: 800px; max-height: 90vh; overflow-y: auto;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; position: sticky; top: 0; background: white; z-index: 10; padding-bottom: 15px; border-bottom: 2px solid #f1f5f9;">
            <h3 style="margin: 0;">📊 รายงานประจำวัน - รายเตียง</h3>
            <button onclick="this.closest('.modal').remove()" style="
              background: #ef4444;
              color: white;
              border: none;
              padding: 8px 12px;
              border-radius: 8px;
              cursor: pointer;
              font-size: 16px;
            ">✕</button>
          </div>

          <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 25px;">
            <div style="background: linear-gradient(135deg, #f0f9ff, #e0f2fe); padding: 20px; border-radius: 12px; text-align: center;">
              <div style="font-size: 24px; font-weight: 700; color: #0ea5e9;">${totalActive}</div>
              <div style="font-size: 12px; color: #64748b;">เตียงที่ใช้งาน</div>
            </div>
            <div style="background: linear-gradient(135deg, ${totalCritical > 0 ? '#fef2f2, #fee2e2' : '#f0fdf4, #dcfce7'}); padding: 20px; border-radius: 12px; text-align: center;">
              <div style="font-size: 24px; font-weight: 700; color: ${totalCritical > 0 ? '#ef4444' : '#22c55e'};">${totalCritical}</div>
              <div style="font-size: 12px; color: #64748b;">เตียงวิกฤต</div>
            </div>
            <div style="background: linear-gradient(135deg, #fafafa, #f5f5f5); padding: 20px; border-radius: 12px; text-align: center;">
              <div style="font-size: 24px; font-weight: 700; color: #64748b;">${8 - totalActive}</div>
              <div style="font-size: 12px; color: #64748b;">เตียงว่าง</div>
            </div>
          </div>

          <div style="margin-bottom: 20px; padding: 15px; background: #f8fafc; border-radius: 10px; border-left: 4px solid #0ea5e9;">
            <div style="font-size: 12px; color: #64748b;">
              📅 วันที่: ${new Date().toLocaleDateString('th-TH')} | 
              ⏰ เวลา: ${new Date().toLocaleTimeString('th-TH')} | 
              👤 ผู้รายงาน: ${currentUser.fullname}
            </div>
          </div>

          <div style="max-height: 500px; overflow-y: auto;">
            ${bedsHTML}
          </div>

          <div style="margin-top: 20px; text-align: center; position: sticky; bottom: 0; background: white; padding-top: 15px; border-top: 2px solid #f1f5f9;">
            <button class="btn btn-secondary" onclick="printSummaryReport()" style="margin-right: 10px;">🖨️ พิมพ์รายงาน</button>
            <button class="btn btn-primary" onclick="this.closest('.modal').remove()">ปิด</button>
          </div>
        </div>
      `;

      document.body.appendChild(modal);
    }

    function printSummaryReport() {
      window.print();
    }

    function openResetModal() {
      document.getElementById('resetModal').style.display = 'flex';
    }

    function resetAllData() {
      if (!confirm('ยืนยันการลบข้อมูลทั้งหมด? การกระทำนี้ไม่สามารถย้อนกลับได้')) return;

      for (let i = 1; i <= 99; i++) {
        localStorage.removeItem(`ir_data_bed_${i}`);
        localStorage.removeItem(`nurseNotes_${i}`);
        localStorage.removeItem(`io_records_bed_${i}`);
        localStorage.removeItem(`vitals_bed_${i}`);
        localStorage.removeItem(`medications_bed_${i}`);
      }

      closeModal('resetModal');
      alert('✅ ลบข้อมูลเรียบร้อยแล้ว');
      location.reload();
    }

    function logout() {
      if (confirm('ต้องการออกจากระบบ?')) {
        sessionStorage.removeItem('currentUser');
        window.location.href = 'index.html';
      }
    }

    // ปิด modal เมื่อคลิกนอกพื้นที่
    document.addEventListener('click', function(e) {
      if (e.target.classList.contains('modal')) {
        e.target.style.display = 'none';
      }
    });
  </script>
</body>
</html>