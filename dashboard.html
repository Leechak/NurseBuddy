<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>NurseBuddy Dashboard</title>
  <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Sarabun', sans-serif;
      background: linear-gradient(135deg, #f0f9ff, #e0f2fe);
      min-height: 100vh;
      padding: 10px;
    }

    .header {
      background: linear-gradient(135deg, #0ea5e9, #0284c7);
      color: white;
      padding: 25px;
      border-radius: 15px;
      margin-bottom: 25px;
      text-align: center;
      box-shadow: 0 8px 25px rgba(14, 165, 233, 0.3);
      position: relative;
      overflow: hidden;
    }

    .header::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="20" cy="20" r="2" fill="rgba(255,255,255,0.1)"/><circle cx="80" cy="80" r="2" fill="rgba(255,255,255,0.1)"/></svg>');
      pointer-events: none;
    }

    .header h1 {
      font-size: 28px;
      margin-bottom: 8px;
      position: relative;
      z-index: 1;
    }

    .header p {
      font-size: 16px;
      opacity: 0.9;
      position: relative;
      z-index: 1;
    }

    .user-info {
      background: rgba(255,255,255,0.2);
      padding: 12px 20px;
      border-radius: 10px;
      font-size: 14px;
      margin-top: 15px;
      display: inline-block;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255,255,255,0.3);
      position: relative;
      z-index: 1;
    }

    .quick-actions {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .action-card {
      background: white;
      border-radius: 15px;
      padding: 25px;
      text-align: center;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
      cursor: pointer;
      transition: all 0.3s ease;
      border: 2px solid transparent;
      position: relative;
      overflow: hidden;
    }

    .action-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(135deg, #0ea5e9, #0284c7);
      transform: scaleX(0);
      transition: transform 0.3s ease;
    }

    .action-card:hover {
      transform: translateY(-8px);
      border-color: #0ea5e9;
      box-shadow: 0 12px 35px rgba(14, 165, 233, 0.25);
    }

    .action-card:active {
      transform: translateY(-4px);
    }

    .action-icon {
      font-size: 56px;
      margin-bottom: 20px;
      display: block;
    }

    .action-title {
      font-size: 20px;
      font-weight: 600;
      color: #1e293b;
      margin-bottom: 8px;
    }

    .action-desc {
      font-size: 14px;
      color: #64748b;
      line-height: 1.5;
    }

    .beds-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
      gap: 25px;
      margin-bottom: 30px;
    }

    .bed-card {
      background: white;
      border-radius: 20px;
      padding: 0;
      box-shadow: 0 8px 30px rgba(0,0,0,0.12);
      transition: all 0.4s ease;
      cursor: pointer;
      text-decoration: none;
      color: inherit;
      position: relative;
      border: 3px solid transparent;
      overflow: hidden;
    }

    .bed-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 6px;
      background: linear-gradient(135deg, #0ea5e9, #0284c7);
      transform: scaleX(0);
      transition: transform 0.4s ease;
    }

    .bed-card:hover::before {
      transform: scaleX(1);
    }

    .bed-card:hover {
      transform: translateY(-10px) scale(1.02);
      box-shadow: 0 20px 50px rgba(14, 165, 233, 0.2);
      border-color: rgba(14, 165, 233, 0.3);
    }

    .bed-card:active {
      transform: translateY(-5px) scale(1.01);
    }

    .bed-header {
      background: linear-gradient(135deg, #f8fafc, #f1f5f9);
      padding: 20px 25px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid #e2e8f0;
      position: relative;
    }

    .bed-number {
      font-size: 22px;
      font-weight: 800;
      color: #1e293b;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .bed-icon {
      font-size: 24px;
      padding: 8px;
      background: linear-gradient(135deg, #e0f2fe, #bae6fd);
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .status-indicator {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
    }

    .status-dot {
      width: 16px;
      height: 16px;
      border-radius: 50%;
      background: #22c55e;
      animation: pulse 2s infinite;
      box-shadow: 0 0 0 6px rgba(34, 197, 94, 0.2);
      position: relative;
    }

    .status-dot::after {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: white;
    }

    .status-dot.inactive {
      background: #94a3b8;
      animation: none;
      box-shadow: 0 0 0 6px rgba(148, 163, 184, 0.2);
    }

    .status-dot.warning {
      background: #f59e0b;
      box-shadow: 0 0 0 6px rgba(245, 158, 11, 0.2);
    }

    .status-dot.error {
      background: #ef4444;
      box-shadow: 0 0 0 6px rgba(239, 68, 68, 0.2);
    }

    .status-text {
      font-size: 10px;
      font-weight: 600;
      color: #64748b;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    @keyframes pulse {
      0%, 100% { 
        opacity: 1; 
        transform: scale(1);
      }
      50% { 
        opacity: 0.6; 
        transform: scale(1.2);
      }
    }

    .bed-content {
      padding: 25px;
    }

    .flow-rate-section {
      background: linear-gradient(135deg, #f0f9ff, #e0f2fe);
      padding: 20px;
      border-radius: 15px;
      margin-bottom: 20px;
      text-align: center;
      border: 2px solid rgba(14, 165, 233, 0.1);
    }

    .flow-rate {
      font-size: 24px;
      font-weight: 800;
      color: #0ea5e9;
      margin-bottom: 5px;
      display: block;
    }

    .flow-rate-label {
      font-size: 12px;
      color: #0369a1;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .patient-info {
      background: linear-gradient(135deg, #fafafa, #f5f5f5);
      padding: 20px;
      border-radius: 15px;
      margin-bottom: 15px;
      border: 2px solid #e5e7eb;
      position: relative;
      overflow: hidden;
    }

    .patient-info::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      bottom: 0;
      width: 4px;
      background: linear-gradient(135deg, #0ea5e9, #0284c7);
    }

    .patient-info-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
      padding: 8px 0;
    }

    .patient-info-row:last-child {
      margin-bottom: 0;
    }

    .patient-info-label {
      font-size: 12px;
      color: #64748b;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .patient-info-value {
      font-size: 14px;
      color: #1e293b;
      font-weight: 700;
      text-align: right;
    }

    .comparison-section {
      background: linear-gradient(135deg, #e0f2fe, #bae6fd);
      padding: 18px;
      border-radius: 12px;
      margin-bottom: 15px;
      border: 2px solid rgba(14, 165, 233, 0.2);
    }

    .comparison-header {
      font-size: 11px;
      color: #0c4a6e;
      font-weight: 700;
      margin-bottom: 12px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .comparison-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin-bottom: 12px;
    }

    .comparison-item {
      text-align: center;
      background: rgba(255, 255, 255, 0.8);
      padding: 12px 8px;
      border-radius: 8px;
      border: 1px solid rgba(14, 165, 233, 0.2);
    }

    .comparison-label {
      font-size: 10px;
      color: #0369a1;
      margin-bottom: 4px;
      font-weight: 600;
    }

    .comparison-value {
      font-size: 16px;
      font-weight: 800;
      color: #0ea5e9;
    }

    .variance-indicator {
      background: rgba(255, 255, 255, 0.9);
      padding: 8px 12px;
      border-radius: 8px;
      text-align: center;
      font-size: 11px;
      font-weight: 700;
      border: 1px solid rgba(14, 165, 233, 0.2);
    }

    .stats-row {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
      margin-bottom: 15px;
    }

    .stat-mini {
      background: linear-gradient(135deg, #f8fafc, #f1f5f9);
      padding: 12px 8px;
      border-radius: 10px;
      text-align: center;
      border: 1px solid #e2e8f0;
    }

    .stat-mini-value {
      font-size: 16px;
      font-weight: 800;
      color: #1e293b;
      margin-bottom: 2px;
    }

    .stat-mini-label {
      font-size: 9px;
      color: #64748b;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.3px;
    }

    .last-update {
      background: #f8fafc;
      padding: 12px 15px;
      border-radius: 10px;
      font-size: 10px;
      color: #64748b;
      text-align: center;
      margin-top: 15px;
      border: 1px solid #e2e8f0;
      font-weight: 500;
    }

    .empty-bed {
      text-align: center;
      padding: 40px 20px;
      background: linear-gradient(135deg, #f8fafc, #f1f5f9);
      border-radius: 15px;
      border: 2px dashed #cbd5e1;
      color: #64748b;
    }

    .empty-bed-icon {
      font-size: 48px;
      margin-bottom: 15px;
      opacity: 0.6;
    }

    .empty-bed-title {
      font-size: 16px;
      font-weight: 700;
      margin-bottom: 8px;
      color: #374151;
    }

    .empty-bed-desc {
      font-size: 12px;
      font-style: italic;
    }

    .summary-section {
      background: white;
      border-radius: 15px;
      padding: 30px;
      margin-bottom: 25px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
      border: 1px solid rgba(14, 165, 233, 0.1);
    }

    .summary-header {
      display: flex;
      align-items: center;
      margin-bottom: 25px;
      padding-bottom: 15px;
      border-bottom: 2px solid #f1f5f9;
    }

    .summary-title {
      font-size: 22px;
      font-weight: 700;
      color: #1e293b;
      margin-left: 15px;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 20px;
    }

    .stat-card {
      background: linear-gradient(135deg, #f1f5f9, #e2e8f0);
      padding: 20px;
      border-radius: 12px;
      text-align: center;
      transition: all 0.3s ease;
      border: 2px solid transparent;
      cursor: pointer;
    }

    .stat-card:hover {
      border-color: #0ea5e9;
      transform: translateY(-3px);
      box-shadow: 0 8px 25px rgba(14, 165, 233, 0.15);
    }

    .stat-value {
      font-size: 28px;
      font-weight: 700;
      color: #0ea5e9;
      margin-bottom: 8px;
    }

    .stat-label {
      font-size: 13px;
      color: #64748b;
      font-weight: 500;
    }

    .stat-detail {
      font-size: 11px;
      color: #64748b;
      margin-top: 5px;
    }

    .admin-controls {
      position: fixed;
      top: 20px;
      right: 20px;
      display: flex;
      gap: 12px;
      z-index: 1000;
    }

    .admin-btn {
      background: linear-gradient(135deg, #ef4444, #dc2626);
      color: white;
      border: none;
      padding: 14px 18px;
      border-radius: 10px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(239, 68, 68, 0.3);
      border: 1px solid rgba(255,255,255,0.1);
    }

    .admin-btn:hover {
      background: linear-gradient(135deg, #dc2626, #b91c1c);
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(239, 68, 68, 0.4);
    }

    .admin-btn:active {
      transform: translateY(0);
    }

    .admin-btn.secondary {
      background: linear-gradient(135deg, #64748b, #475569);
      box-shadow: 0 4px 15px rgba(100, 116, 139, 0.3);
    }

    .admin-btn.secondary:hover {
      background: linear-gradient(135deg, #475569, #334155);
      box-shadow: 0 6px 20px rgba(100, 116, 139, 0.4);
    }

    @media (max-width: 768px) {
      .quick-actions {
        grid-template-columns: repeat(2, 1fr);
        gap: 15px;
      }

      .beds-grid {
        grid-template-columns: repeat(2, 1fr);
        gap: 15px;
      }

      .admin-controls {
        position: relative;
        top: auto;
        right: auto;
        margin-bottom: 20px;
        justify-content: center;
        flex-wrap: wrap;
      }

      .stats-grid {
        grid-template-columns: repeat(2, 1fr);
        gap: 15px;
      }

      .action-card {
        padding: 18px;
      }

      .action-icon {
        font-size: 42px;
        margin-bottom: 12px;
      }

      .action-title {
        font-size: 16px;
      }

      .action-desc {
        font-size: 12px;
      }

      .bed-card {
        margin-bottom: 0;
      }

      .bed-header {
        padding: 15px 20px;
      }

      .bed-number {
        font-size: 18px;
      }

      .bed-content {
        padding: 20px;
      }

      .flow-rate {
        font-size: 20px;
      }

      .comparison-grid {
        gap: 8px;
      }

      .comparison-item {
        padding: 10px 6px;
      }

      .stats-row {
        gap: 8px;
      }

      .stat-mini {
        padding: 10px 6px;
      }

      .patient-info {
        padding: 15px;
      }

      .comparison-section {
        padding: 15px;
      }
    }

    @media (max-width: 480px) {
      body {
        padding: 8px;
      }

      .header {
        padding: 20px 15px;
        margin-bottom: 20px;
      }

      .header h1 {
        font-size: 22px;
      }

      .header p {
        font-size: 14px;
      }

      .user-info {
        font-size: 12px;
        padding: 10px 15px;
      }

      .quick-actions {
        grid-template-columns: 1fr;
        gap: 12px;
      }

      .beds-grid {
        grid-template-columns: 1fr;
        gap: 15px;
      }

      .stats-grid {
        grid-template-columns: 1fr;
        gap: 12px;
      }

      .admin-controls {
        gap: 8px;
      }

      .admin-btn {
        padding: 10px 14px;
        font-size: 12px;
      }

      .action-card {
        padding: 15px;
      }

      .action-icon {
        font-size: 36px;
        margin-bottom: 10px;
      }

      .action-title {
        font-size: 14px;
      }

      .action-desc {
        font-size: 11px;
      }

      .bed-header {
        padding: 12px 15px;
      }

      .bed-number {
        font-size: 16px;
      }

      .bed-icon {
        font-size: 20px;
        padding: 6px;
      }

      .bed-content {
        padding: 15px;
      }

      .flow-rate-section {
        padding: 15px;
        margin-bottom: 15px;
      }

      .flow-rate {
        font-size: 20px;
      }

      .flow-rate-label {
        font-size: 11px;
      }

      .patient-info {
        padding: 12px;
        margin-bottom: 12px;
      }

      .patient-info-row {
        padding: 6px 0;
        margin-bottom: 8px;
      }

      .patient-info-label {
        font-size: 11px;
      }

      .patient-info-value {
        font-size: 12px;
      }

      .comparison-section {
        padding: 12px;
        margin-bottom: 12px;
      }

      .comparison-header {
        font-size: 10px;
        margin-bottom: 8px;
      }

      .comparison-grid {
        gap: 6px;
        margin-bottom: 8px;
      }

      .comparison-item {
        padding: 8px 4px;
      }

      .comparison-label {
        font-size: 9px;
      }

      .comparison-value {
        font-size: 14px;
      }

      .variance-indicator {
        padding: 6px 8px;
        font-size: 10px;
      }

      .stats-row {
        gap: 6px;
        margin-bottom: 12px;
      }

      .stat-mini {
        padding: 8px 4px;
      }

      .stat-mini-value {
        font-size: 14px;
      }

      .stat-mini-label {
        font-size: 8px;
      }

      .last-update {
        padding: 8px 10px;
        margin-top: 12px;
        font-size: 9px;
      }

      .empty-bed {
        padding: 25px 15px;
      }

      .empty-bed-icon {
        font-size: 36px;
        margin-bottom: 10px;
      }

      .empty-bed-title {
        font-size: 14px;
        margin-bottom: 6px;
      }

      .empty-bed-desc {
        font-size: 11px;
      }

      .summary-section {
        padding: 20px 15px;
        margin-bottom: 20px;
      }

      .summary-title {
        font-size: 18px;
      }

      .stat-card {
        padding: 15px;
      }

      .stat-value {
        font-size: 22px;
      }

      .stat-label {
        font-size: 11px;
      }

      .stat-detail {
        font-size: 10px;
      }
    }

    .modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 2000;
      padding: 20px;
    }

    .modal-content {
      background: white;
      padding: 30px;
      border-radius: 15px;
      max-width: 500px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 20px 50px rgba(0,0,0,0.3);
    }

    .modal h3 {
      font-size: 20px;
      font-weight: 700;
      margin-bottom: 20px;
      color: #1e293b;
      padding-bottom: 10px;
      border-bottom: 2px solid #f1f5f9;
    }

    .btn {
      padding: 14px 24px;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      margin: 8px 5px;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
      position: relative;
      overflow: hidden;
    }

    .btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
      transition: left 0.5s;
    }

    .btn:hover::before {
      left: 100%;
    }

    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(0,0,0,0.15);
    }

    .btn:active {
      transform: translateY(0);
    }

    .btn-primary {
      background: linear-gradient(135deg, #0ea5e9, #0284c7);
      color: white;
    }

    .btn-secondary {
      background: linear-gradient(135deg, #64748b, #475569);
      color: white;
    }

    .btn-danger {
      background: linear-gradient(135deg, #ef4444, #dc2626);
      color: white;
    }

    .input-group {
      margin-bottom: 20px;
    }

    .input-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: #374151;
      font-size: 14px;
    }

    .input-group input,
    .input-group select {
      width: 100%;
      padding: 12px 15px;
      border: 2px solid #e5e7eb;
      border-radius: 10px;
      font-size: 14px;
      transition: all 0.3s ease;
    }

    .input-group input:focus,
    .input-group select:focus {
      border-color: #0ea5e9;
      outline: none;
      box-shadow: 0 0 0 3px rgba(14, 165, 233, 0.1);
    }

    .loading {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      color: #64748b;
      padding: 20px;
    }

    .spinner {
      width: 20px;
      height: 20px;
      border: 2px solid #e5e7eb;
      border-top: 2px solid #0ea5e9;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .empty-state {
      text-align: center;
      padding: 40px 20px;
      color: #64748b;
      font-style: italic;
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>üè• NurseBuddy Dashboard</h1>
    <p>‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏ô‡πâ‡∏≥‡πÄ‡∏Å‡∏•‡∏∑‡∏≠‡∏≠‡∏±‡∏à‡∏â‡∏£‡∏¥‡∏¢‡∏∞ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢</p>
    <div class="user-info" id="userInfo">üë§ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>
  </div>

  <div class="admin-controls" id="adminControls" style="display: none;">
    <button class="admin-btn secondary" onclick="openSummaryModal()">üìä ‡∏™‡∏£‡∏∏‡∏õ</button>
    <button class="admin-btn" onclick="openResetModal()">üóëÔ∏è ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï</button>
    <button class="admin-btn secondary" onclick="logout()">üö™ ‡∏≠‡∏≠‡∏Å</button>
  </div>

  <div class="quick-actions">
    <div class="action-card" onclick="showQuickAdd()">
      <div class="action-icon">‚ö°</div>
      <div class="action-title">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡πÉ‡∏´‡∏°‡πà</div>
      <div class="action-desc">‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡∏ô‡∏ó‡∏µ</div>
    </div>

    <div class="action-card" onclick="showIOEntry()">
      <div class="action-icon">üíß</div>
      <div class="action-title">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å I/O</div>
      <div class="action-desc">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≤‡∏£‡∏ô‡πâ‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤-‡∏≠‡∏≠‡∏Å‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏£‡∏ß‡∏î‡πÄ‡∏£‡πá‡∏ß</div>
    </div>

    <div class="action-card" onclick="showQuickCalc()">
      <div class="action-icon">üßÆ</div>
      <div class="action-title">‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ô‡πâ‡∏≥‡πÄ‡∏Å‡∏•‡∏∑‡∏≠</div>
      <div class="action-desc">‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏Å‡∏≤‡∏£‡πÑ‡∏´‡∏•‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥‡∏ó‡∏±‡∏ô‡∏ó‡∏µ</div>
    </div>
  </div>

  <div class="summary-section">
    <div class="summary-header">
      <span style="font-size: 28px;">üìä</span>
      <div class="summary-title">‡∏™‡∏£‡∏∏‡∏õ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏£‡∏∞‡∏ö‡∏ö</div>
    </div>
    <div class="stats-grid">
        <div class="stat-card" onclick="showActiveBedsDetails()">
          <div class="stat-value" id="totalBeds">0</div>
          <div class="stat-label">‡πÄ‡∏ï‡∏µ‡∏¢‡∏á‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</div>
          <div class="stat-detail">‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</div>
        </div>
        <div class="stat-card" onclick="showNotesHistory()">
          <div class="stat-value" id="totalNotes">0</div>
          <div class="stat-label">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>
          <div class="stat-detail">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏î‡∏π‡πÅ‡∏•‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢</div>
        </div>
        <div class="stat-card" onclick="showIOSummary()">
          <div class="stat-value" id="totalIORecords">0</div>
          <div class="stat-label">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å I/O</div>
          <div class="stat-detail">‡∏™‡∏≤‡∏£‡∏ô‡πâ‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤-‡∏≠‡∏≠‡∏Å</div>
        </div>
        <div class="stat-card" onclick="showVitalsSummary()">
          <div class="stat-value" id="totalVitals">0</div>
          <div class="stat-label">Vital Signs</div>
          <div class="stat-detail">‡∏Å‡∏≤‡∏£‡∏ß‡∏±‡∏î‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì‡∏ä‡∏µ‡∏û</div>
        </div>
        <div class="stat-card" onclick="showMedicationSummary()">
          <div class="stat-value" id="totalMedications">0</div>
          <div class="stat-label">‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Å‡∏≤‡∏£‡∏¢‡∏≤</div>
          <div class="stat-detail">‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÉ‡∏´‡πâ‡∏¢‡∏≤</div>
        </div>
        <div class="stat-card alert-card" onclick="showAlertsDetails()">
          <div class="stat-value" id="alertCount">0</div>
          <div class="stat-label">‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô</div>
          <div class="stat-detail" id="alertDetail">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô</div>
        </div>
      </div>
  </div>

  <div class="beds-grid" id="bedsGrid">
    <div class="loading">
      <div class="spinner"></div>
      <span>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏ï‡∏µ‡∏¢‡∏á...</span>
    </div>
  </div>

  <!-- Quick Add Modal -->
  <div class="modal" id="quickAddModal">
    <div class="modal-content">
      <h3>‚ö° ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡πÉ‡∏´‡∏°‡πà</h3>
      <div class="input-group">
        <label>‡πÄ‡∏ï‡∏µ‡∏¢‡∏á‡∏ó‡∏µ‡πà:</label>
        <select id="bedSelect">
          <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏ï‡∏µ‡∏¢‡∏á</option>
        </select>
      </div>
      <div class="input-group">
        <label>‡∏£‡∏´‡∏±‡∏™‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢:</label>
        <input type="text" id="patientId" placeholder="P001234">
      </div>
      <div class="input-group">
        <label>‡∏¢‡∏≤/‡∏™‡∏≤‡∏£‡∏ô‡πâ‡∏≥:</label>
        <select id="medication">
          <option value="Normal Saline">Normal Saline (0.9% NSS)</option>
          <option value="Dextrose 5%">Dextrose 5% in Water</option>
          <option value="Lactated Ringer's">Lactated Ringer's Solution</option>
          <option value="Dextrose 5% in NSS">D5NSS</option>
          <option value="Half Normal Saline">0.45% NSS</option>
        </select>
      </div>
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
        <div class="input-group">
          <label>‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì (mL):</label>
          <input type="number" id="volume" placeholder="500">
        </div>
        <div class="input-group">
          <label>‡∏≠‡∏±‡∏ï‡∏£‡∏≤ (‡∏î‡∏£‡∏≠‡∏õ/‡∏ô‡∏≤‡∏ó‡∏µ):</label>
          <input type="number" id="rate" placeholder="20">
        </div>
      </div>
      <button class="btn btn-primary" onclick="savePatient()">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡∏∞‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡πÄ‡∏ï‡∏µ‡∏¢‡∏á</button>
      <button class="btn btn-secondary" onclick="closeModal('quickAddModal')">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
    </div>
  </div>

  <!-- I/O Modal -->
  <div class="modal" id="ioModal">
    <div class="modal-content">
      <h3>üíß ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å I/O ‡∏£‡∏ß‡∏î‡πÄ‡∏£‡πá‡∏ß</h3>
      <div class="input-group">
        <label>‡πÄ‡∏ï‡∏µ‡∏¢‡∏á‡∏ó‡∏µ‡πà:</label>
        <select id="ioBedSelect">
          <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏ï‡∏µ‡∏¢‡∏á</option>
        </select>
      </div>
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
        <div>
          <h4 style="color: #22c55e; margin-bottom: 15px;">üì• INPUT</h4>
          <div class="input-group">
            <label>‡∏ô‡πâ‡∏≥‡∏î‡∏∑‡πà‡∏° (mL):</label>
            <input type="number" id="inputWater" placeholder="0">
          </div>
          <div class="input-group">
            <label>‡∏ô‡πâ‡∏≥‡πÄ‡∏Å‡∏•‡∏∑‡∏≠ IV (mL):</label>
            <input type="number" id="inputIV" placeholder="0">
          </div>
        </div>
        <div>
          <h4 style="color: #ef4444; margin-bottom: 15px;">üì§ OUTPUT</h4>
          <div class="input-group">
            <label>‡∏õ‡∏±‡∏™‡∏™‡∏≤‡∏ß‡∏∞ (mL):</label>
            <input type="number" id="outputUrine" placeholder="0">
          </div>
          <div class="input-group">
            <label>‡∏≠‡∏≤‡πÄ‡∏à‡∏µ‡∏¢‡∏ô (mL):</label>
            <input type="number" id="outputVomit" placeholder="0">
          </div>
        </div>
      </div>
      <button class="btn btn-primary" onclick="saveIO()">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å I/O</button>
      <button class="btn btn-secondary" onclick="closeModal('ioModal')">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
    </div>
  </div>

  <!-- Calculator Modal -->
  <div class="modal" id="calcModal">
    <div class="modal-content">
      <h3>üßÆ ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ô‡πâ‡∏≥‡πÄ‡∏Å‡∏•‡∏∑‡∏≠</h3>
      <div class="input-group">
        <label>‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ï‡∏£ (mL):</label>
        <input type="number" id="calcVolume" placeholder="1000">
      </div>
      <div class="input-group">
        <label>‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ (‡∏î‡∏£‡∏≠‡∏õ/‡∏ô‡∏≤‡∏ó‡∏µ):</label>
        <input type="number" id="calcRate" placeholder="30">
      </div>
      <div class="input-group">
        <label>Drop Factor:</label>
        <select id="dropFactor">
          <option value="20">20 ‡∏´‡∏¢‡∏î/cc (‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô)</option>
          <option value="15">15 ‡∏´‡∏¢‡∏î/cc</option>
          <option value="60">60 ‡∏´‡∏¢‡∏î/cc (Micro)</option>
        </select>
      </div>
      <button class="btn btn-primary" onclick="calculateFlow()">üßÆ ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì</button>
      <button class="btn btn-secondary" onclick="closeModal('calcModal')">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
      <div id="calcResult" style="margin-top: 20px; padding: 20px; background: linear-gradient(135deg, #f0f9ff, #e0f2fe); border-radius: 12px; display: none; border: 2px solid #0ea5e9;"></div>
    </div>
  </div>

  <!-- Reset Modal -->
  <div class="modal" id="resetModal">
    <div class="modal-content">
      <h3 style="color: #ef4444;">‚ö†Ô∏è ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</h3>
      <p style="margin-bottom: 20px; color: #64748b;">‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà? ‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏ó‡∏≥‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏î‡πâ</p>
      <button class="btn btn-danger" onclick="resetAllData()">üóëÔ∏è ‡∏•‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
      <button class="btn btn-secondary" onclick="closeModal('resetModal')">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
    </div>
  </div>

  <script>
    let currentUser = null;
    let bedsData = {};

    document.addEventListener('DOMContentLoaded', function() {
      initializeApp();
    });

    function initializeApp() {
      currentUser = JSON.parse(sessionStorage.getItem('currentUser') || 'null');
      if (!currentUser) {
        window.location.href = 'index.html';
        return;
      }

      document.getElementById('userInfo').textContent = `üë§ ${currentUser.fullname} (${currentUser.role})`;

      if (currentUser.role === 'admin') {
        document.getElementById('adminControls').style.display = 'flex';
      }

      setTimeout(() => {
        loadBedsData();
        updateSummary();
        setupBedSelectors();
      }, 500);
    }

    function loadBedsData() {
      const bedsGrid = document.getElementById('bedsGrid');
      bedsGrid.innerHTML = '';

      for (let i = 1; i <= 8; i++) {
        const bedData = JSON.parse(localStorage.getItem(`ir_data_bed_${i}`) || 'null');
        const notes = JSON.parse(localStorage.getItem(`nurseNotes_${i}`) || '[]');
        const ioRecords = JSON.parse(localStorage.getItem(`io_records_bed_${i}`) || '[]');

        bedsData[i] = {
          patientData: bedData,
          notesCount: notes.length,
          ioCount: ioRecords.length,
          lastUpdate: bedData ? new Date(bedData.timestamp).toLocaleString('th-TH') : null
        };

        const bedCard = createBedCard(i, bedsData[i]);
        bedsGrid.appendChild(bedCard);
      }
    }

    function createBedCard(bedNumber, data) {
      const card = document.createElement('a');
      card.href = `chart.html?bed=${bedNumber}`;
      card.className = 'bed-card';

      const statusClass = data.patientData ? 'active' : 'inactive';
      const statusText = data.patientData ? '‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå' : '‡∏ß‡πà‡∏≤‡∏á';

      if (!data.patientData) {
        // ‡πÄ‡∏ï‡∏µ‡∏¢‡∏á‡∏ß‡πà‡∏≤‡∏á
        card.innerHTML = `
          <div class="bed-header">
            <div class="bed-number">
              <div class="bed-icon">üõèÔ∏è</div>
              ‡πÄ‡∏ï‡∏µ‡∏¢‡∏á ${bedNumber}
            </div>
            <div class="status-indicator">
              <div class="status-dot ${statusClass}"></div>
              <div class="status-text">${statusText}</div>
            </div>
          </div>
          <div class="bed-content">
            <div class="empty-bed">
              <div class="empty-bed-icon">‚ûï</div>
              <div class="empty-bed-title">‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏£‡∏±‡∏ö‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢</div>
              <div class="empty-bed-desc">‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡πÉ‡∏´‡∏°‡πà</div>
            </div>
            <div class="last-update">
              ‡πÄ‡∏ï‡∏µ‡∏¢‡∏á‡∏ß‡πà‡∏≤‡∏á - ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô
            </div>
          </div>
        `;
        return card;
      }

      // ‡∏à‡∏≥‡∏•‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏ß‡∏±‡∏î‡∏à‡∏£‡∏¥‡∏á
      const actualRate = Math.floor(data.patientData.rate * (0.9 + Math.random() * 0.2));
      const variance = actualRate - data.patientData.rate;
      const variancePercent = ((variance / data.patientData.rate) * 100).toFixed(1);
      const varianceColor = Math.abs(variance) <= 2 ? '#22c55e' : Math.abs(variance) <= 5 ? '#f59e0b' : '#ef4444';
      
      // ‡∏õ‡∏£‡∏±‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏î‡∏≠‡∏ó‡∏ï‡∏≤‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏ö‡∏µ‡πà‡∏¢‡∏á‡πÄ‡∏ö‡∏ô
      const dotStatusClass = Math.abs(variance) <= 2 ? 'active' : Math.abs(variance) <= 5 ? 'warning' : 'error';

      card.innerHTML = `
        <div class="bed-header">
          <div class="bed-number">
            <div class="bed-icon">üõèÔ∏è</div>
            ‡πÄ‡∏ï‡∏µ‡∏¢‡∏á ${bedNumber}
          </div>
          <div class="status-indicator">
            <div class="status-dot ${dotStatusClass}"></div>
            <div class="status-text">${statusText}</div>
          </div>
        </div>
        
        <div class="bed-content">
          <div class="flow-rate-section">
            <div class="flow-rate">${data.patientData.rate}</div>
            <div class="flow-rate-label">‡∏î‡∏£‡∏≠‡∏õ/‡∏ô‡∏≤‡∏ó‡∏µ</div>
          </div>

          <div class="patient-info">
            <div class="patient-info-row">
              <div class="patient-info-label">üë§ ‡∏£‡∏´‡∏±‡∏™</div>
              <div class="patient-info-value">${data.patientData.patient_id}</div>
            </div>
            <div class="patient-info-row">
              <div class="patient-info-label">üíä ‡∏¢‡∏≤</div>
              <div class="patient-info-value">${data.patientData.medication}</div>
            </div>
            <div class="patient-info-row">
              <div class="patient-info-label">üíß ‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì</div>
              <div class="patient-info-value">${data.patientData.volume} mL</div>
            </div>
          </div>

          <div class="comparison-section">
            <div class="comparison-header">
              üìä ‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏Å‡∏≤‡∏£‡πÑ‡∏´‡∏•
            </div>
            <div class="comparison-grid">
              <div class="comparison-item">
                <div class="comparison-label">‡∏™‡∏±‡πà‡∏á</div>
                <div class="comparison-value">${data.patientData.rate}</div>
              </div>
              <div class="comparison-item">
                <div class="comparison-label">‡∏ß‡∏±‡∏î‡πÑ‡∏î‡πâ</div>
                <div class="comparison-value" style="color: ${varianceColor};">${actualRate}</div>
              </div>
            </div>
            <div class="variance-indicator" style="color: ${varianceColor};">
              ‡∏™‡πà‡∏ß‡∏ô‡∏ï‡πà‡∏≤‡∏á: ${variance > 0 ? '+' : ''}${variance} ‡∏î‡∏£‡∏≠‡∏õ/‡∏ô‡∏≤‡∏ó‡∏µ (${variancePercent > 0 ? '+' : ''}${variancePercent}%)
            </div>
          </div>

          <div class="stats-row">
            <div class="stat-mini">
              <div class="stat-mini-value">${data.notesCount}</div>
              <div class="stat-mini-label">üìù ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</div>
            </div>
            <div class="stat-mini">
              <div class="stat-mini-value">${data.ioCount}</div>
              <div class="stat-mini-label">üíß I/O</div>
            </div>
            <div class="stat-mini">
              <div class="stat-mini-value" style="color: ${Math.abs(variance) <= 2 ? '#22c55e' : '#ef4444'};">
                ${Math.abs(variance) <= 2 ? '‚úì' : '‚ö†'}
              </div>
              <div class="stat-mini-label">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</div>
            </div>
          </div>

          <div class="last-update">
            üïí ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î: ${data.lastUpdate || '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•'}
          </div>
        </div>
      `;

      return card;
    }

    function updateSummary() {
      let activeBeds = 0;
      let totalNotes = 0;
      let alertCount = 0;
      let totalIORecords = 0;
      let totalVitals = 0;
      let totalMedications = 0;

      for (let i = 1; i <= 8; i++) {
        if (bedsData[i] && bedsData[i].patientData) {
          activeBeds++;
        }

        totalNotes += bedsData[i] ? bedsData[i].notesCount : 0;
        totalIORecords += bedsData[i] ? bedsData[i].ioCount : 0;

        // ‡∏ô‡∏±‡∏ö Vital Signs
        const vitals = JSON.parse(localStorage.getItem(`vitals_bed_${i}`) || 'null');
        if (vitals) totalVitals++;

        // ‡∏ô‡∏±‡∏ö Medications
        const medications = JSON.parse(localStorage.getItem(`medications_bed_${i}`) || '[]');
        totalMedications += medications.length;

        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Alerts
        if (vitals) {
          if (vitals.systolic > 140 || vitals.diastolic > 90) alertCount++;
          if (vitals.heartRate > 100 || vitals.heartRate < 60) alertCount++;
          if (vitals.temperature > 37.5) alertCount++;
          if (vitals.oxygen < 95) alertCount++;
        }
      }

      document.getElementById('totalBeds').textContent = activeBeds;
      document.getElementById('totalNotes').textContent = totalNotes;
      document.getElementById('totalIORecords').textContent = totalIORecords;
      document.getElementById('totalVitals').textContent = totalVitals;
      document.getElementById('totalMedications').textContent = totalMedications;
      document.getElementById('alertCount').textContent = alertCount;

      // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ Alert
      const alertDetail = document.getElementById('alertDetail');
      if (alertCount > 0) {
        alertDetail.textContent = `‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö ${alertCount} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`;
        alertDetail.style.color = '#ef4444';
      } else {
        alertDetail.textContent = '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô';
        alertDetail.style.color = '#22c55e';
      }
    }

    // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Ç‡∏≤‡∏î‡∏´‡∏≤‡∏¢‡πÑ‡∏õ
    function setupBedSelectors() {
      const bedSelect = document.getElementById('bedSelect');
      const ioBedSelect = document.getElementById('ioBedSelect');
      
      if (bedSelect) {
        bedSelect.innerHTML = '<option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏ï‡∏µ‡∏¢‡∏á</option>';
        for (let i = 1; i <= 8; i++) {
          bedSelect.innerHTML += `<option value="${i}">‡πÄ‡∏ï‡∏µ‡∏¢‡∏á ${i}</option>`;
        }
      }
      
      if (ioBedSelect) {
        ioBedSelect.innerHTML = '<option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏ï‡∏µ‡∏¢‡∏á</option>';
        for (let i = 1; i <= 8; i++) {
          const bedData = JSON.parse(localStorage.getItem(`ir_data_bed_${i}`) || 'null');
          if (bedData) {
            ioBedSelect.innerHTML += `<option value="${i}">‡πÄ‡∏ï‡∏µ‡∏¢‡∏á ${i} - ${bedData.patient_id}</option>`;
          }
        }
      }
    }

    function showQuickAdd() {
      setupBedSelectors();
      document.getElementById('quickAddModal').style.display = 'flex';
    }

    function showIOEntry() {
      setupBedSelectors();
      document.getElementById('ioModal').style.display = 'flex';
    }

    function showQuickCalc() {
      document.getElementById('calcModal').style.display = 'flex';
    }

    function closeModal(modalId) {
      document.getElementById(modalId).style.display = 'none';
    }

    function savePatient() {
      const bedNum = document.getElementById('bedSelect').value;
      const patientId = document.getElementById('patientId').value;
      const medication = document.getElementById('medication').value;
      const volume = document.getElementById('volume').value;
      const rate = document.getElementById('rate').value;

      if (!bedNum || !patientId || !volume || !rate) {
        alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô');
        return;
      }

      const data = {
        patient_id: patientId,
        medication: medication,
        volume: volume,
        rate: rate,
        timestamp: new Date().toISOString()
      };

      localStorage.setItem(`ir_data_bed_${bedNum}`, JSON.stringify(data));
      closeModal('quickAddModal');
      alert('‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');
      
      // ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
      loadBedsData();
      updateSummary();
      
      // ‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ï‡∏µ‡∏¢‡∏á
      setTimeout(() => {
        window.location.href = `chart.html?bed=${bedNum}`;
      }, 500);
    }

    function saveIO() {
      const bedNum = document.getElementById('ioBedSelect').value;
      const inputWater = parseFloat(document.getElementById('inputWater').value) || 0;
      const inputIV = parseFloat(document.getElementById('inputIV').value) || 0;
      const outputUrine = parseFloat(document.getElementById('outputUrine').value) || 0;
      const outputVomit = parseFloat(document.getElementById('outputVomit').value) || 0;

      if (!bedNum) {
        alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏ï‡∏µ‡∏¢‡∏á');
        return;
      }

      const totalIn = inputWater + inputIV;
      const totalOut = outputUrine + outputVomit;
      const balance = totalIn - totalOut;

      const ioRecord = {
        time: new Date().toLocaleString('th-TH'),
        inputWater: inputWater,
        inputIV: inputIV,
        outputUrine: outputUrine,
        outputVomit: outputVomit,
        totalIn: totalIn,
        totalOut: totalOut,
        balance: balance,
        nurse: currentUser.fullname
      };

      const existingRecords = JSON.parse(localStorage.getItem(`io_records_bed_${bedNum}`) || '[]');
      existingRecords.push(ioRecord);
      localStorage.setItem(`io_records_bed_${bedNum}`, JSON.stringify(existingRecords));

      closeModal('ioModal');
      alert('‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å I/O ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');
      
      // ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
      loadBedsData();
      updateSummary();
    }

    function calculateFlow() {
      const volume = parseFloat(document.getElementById('calcVolume').value) || 0;
      const rate = parseFloat(document.getElementById('calcRate').value) || 0;
      const dropFactor = parseFloat(document.getElementById('dropFactor').value) || 20;

      if (!volume || !rate) {
        alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô');
        return;
      }

      const ccPerHr = (rate * 60) / dropFactor;
      const timeToFinish = volume / ccPerHr;
      const finishTime = new Date(Date.now() + (timeToFinish * 60 * 60 * 1000));

      const resultDiv = document.getElementById('calcResult');
      resultDiv.innerHTML = `
        <h4>üìä ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì</h4>
        <div style="margin: 15px 0;">
          <strong>‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏Å‡∏≤‡∏£‡πÑ‡∏´‡∏•:</strong> ${ccPerHr.toFixed(1)} cc/hr
        </div>
        <div style="margin: 15px 0;">
          <strong>‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏´‡∏°‡∏î:</strong> ${timeToFinish.toFixed(1)} ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á
        </div>
        <div style="margin: 15px 0;">
          <strong>‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏Ñ‡∏≤‡∏î‡∏ß‡πà‡∏≤‡∏à‡∏∞‡∏´‡∏°‡∏î:</strong> ${finishTime.toLocaleString('th-TH')}
        </div>
      `;
      resultDiv.style.display = 'block';
    }

    function showActiveBedsDetails() {
      const modal = document.createElement('div');
      modal.className = 'modal';
      modal.style.display = 'flex';

      let bedsHTML = '';
      let count = 0;

      for (let i = 1; i <= 8; i++) {
        if (bedsData[i] && bedsData[i].patientData) {
          count++;
          const data = bedsData[i].patientData;
          
          // ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö (‡∏à‡∏≥‡∏•‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ß‡∏±‡∏î‡∏à‡∏£‡∏¥‡∏á)
          const actualRate = Math.floor(data.rate * (0.9 + Math.random() * 0.2)); // ‡∏à‡∏≥‡∏•‡∏≠‡∏á‡∏Ñ‡πà‡∏≤‡∏ß‡∏±‡∏î‡∏à‡∏£‡∏¥‡∏á ¬±10%
          const variance = actualRate - data.rate;
          const variancePercent = ((variance / data.rate) * 100).toFixed(1);
          
          const statusColor = Math.abs(variance) <= 2 ? '#22c55e' : Math.abs(variance) <= 5 ? '#f59e0b' : '#ef4444';
          const statusText = Math.abs(variance) <= 2 ? '‡∏õ‡∏Å‡∏ï‡∏¥' : Math.abs(variance) <= 5 ? '‡πÄ‡∏ù‡πâ‡∏≤‡∏£‡∏∞‡∏ß‡∏±‡∏á' : '‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö';

          bedsHTML += `
            <div style="
              background: white;
              border-radius: 15px;
              padding: 20px;
              margin: 12px 0;
              border: 2px solid ${statusColor};
              box-shadow: 0 4px 15px rgba(0,0,0,0.1);
              transition: all 0.3s ease;
            ">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <h4 style="color: #1e293b; margin: 0; font-size: 18px;">üõèÔ∏è ‡πÄ‡∏ï‡∏µ‡∏¢‡∏á ${i}</h4>
                <div style="
                  background: ${statusColor};
                  color: white;
                  padding: 6px 12px;
                  border-radius: 20px;
                  font-size: 12px;
                  font-weight: 600;
                ">${statusText}</div>
              </div>

              <div style="background: linear-gradient(135deg, #f8fafc, #f1f5f9); padding: 15px; border-radius: 10px; margin-bottom: 15px;">
                <div style="font-weight: 600; color: #1e293b; margin-bottom: 8px;">üë§ ${data.patient_id}</div>
                <div style="color: #64748b; font-size: 14px;">üíä ${data.medication}</div>
                <div style="color: #64748b; font-size: 14px;">üíß ${data.volume} mL</div>
              </div>

              <div style="
                background: linear-gradient(135deg, #e0f2fe, #bae6fd);
                padding: 15px;
                border-radius: 10px;
                border-left: 4px solid #0ea5e9;
              ">
                <div style="font-size: 14px; font-weight: 600; color: #0c4a6e; margin-bottom: 10px;">üìä ‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏Å‡∏≤‡∏£‡πÑ‡∏´‡∏•</div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 10px;">
                  <div>
                    <div style="font-size: 12px; color: #0369a1;">‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏ó‡∏µ‡πà‡∏™‡∏±‡πà‡∏á</div>
                    <div style="font-size: 18px; font-weight: 700; color: #0ea5e9;">${data.rate} ‡∏î‡∏£‡∏≠‡∏õ/‡∏ô‡∏≤‡∏ó‡∏µ</div>
                  </div>
                  <div>
                    <div style="font-size: 12px; color: #0369a1;">‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏ó‡∏µ‡πà‡∏ß‡∏±‡∏î‡πÑ‡∏î‡πâ</div>
                    <div style="font-size: 18px; font-weight: 700; color: ${statusColor};">${actualRate} ‡∏î‡∏£‡∏≠‡∏õ/‡∏ô‡∏≤‡∏ó‡∏µ</div>
                  </div>
                </div>

                <div style="
                  background: rgba(255,255,255,0.8);
                  padding: 10px;
                  border-radius: 8px;
                  display: flex;
                  justify-content: space-between;
                  align-items: center;
                ">
                  <span style="font-size: 12px; color: #0369a1;">‡∏™‡πà‡∏ß‡∏ô‡∏ï‡πà‡∏≤‡∏á:</span>
                  <span style="font-size: 14px; font-weight: 600; color: ${statusColor};">
                    ${variance > 0 ? '+' : ''}${variance} ‡∏î‡∏£‡∏≠‡∏õ/‡∏ô‡∏≤‡∏ó‡∏µ (${variancePercent > 0 ? '+' : ''}${variancePercent}%)
                  </span>
                </div>
              </div>

              <div style="margin-top: 12px; font-size: 11px; color: #64748b; text-align: right;">
                ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î: ${bedsData[i].lastUpdate}
              </div>
            </div>
          `;
        }
      }

      if (count === 0) {
        bedsHTML = `
          <div style="
            text-align: center;
            padding: 40px 20px;
            color: #64748b;
            font-style: italic;
            background: linear-gradient(135deg, #f8fafc, #f1f5f9);
            border-radius: 15px;
            border: 2px dashed #cbd5e1;
          ">
            <div style="font-size: 48px; margin-bottom: 15px;">üè•</div>
            <div style="font-size: 18px; font-weight: 600; margin-bottom: 8px;">‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏ï‡∏µ‡∏¢‡∏á‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</div>
            <div style="font-size: 14px;">‡∏ó‡∏∏‡∏Å‡πÄ‡∏ï‡∏µ‡∏¢‡∏á‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏£‡∏±‡∏ö‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡πÉ‡∏´‡∏°‡πà</div>
          </div>
        `;
      }

      modal.innerHTML = `
        <div class="modal-content" style="max-width: 600px; max-height: 90vh; overflow-y: auto;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; position: sticky; top: 0; background: white; z-index: 10; padding-bottom: 15px; border-bottom: 2px solid #f1f5f9;">
            <h3 style="margin: 0; color: #1e293b;">üõèÔ∏è ‡πÄ‡∏ï‡∏µ‡∏¢‡∏á‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô (${count} ‡πÄ‡∏ï‡∏µ‡∏¢‡∏á)</h3>
            <button onclick="this.closest('.modal').remove()" style="
              background: #ef4444;
              color: white;
              border: none;
              padding: 8px 12px;
              border-radius: 8px;
              cursor: pointer;
              font-size: 16px;
              transition: all 0.3s ease;
            ">‚úï</button>
          </div>
          
          <div style="max-height: 500px; overflow-y: auto;">
            ${bedsHTML}
          </div>

          <div style="margin-top: 20px; text-align: center; position: sticky; bottom: 0; background: white; padding-top: 15px; border-top: 2px solid #f1f5f9;">
            <button class="btn btn-primary" onclick="this.closest('.modal').remove()">‡∏õ‡∏¥‡∏î</button>
          </div>
        </div>
      `;

      document.body.appendChild(modal);
    }

    function showNotesHistory() {
      let allNotes = [];

      for (let i = 1; i <= 8; i++) {
        const notes = JSON.parse(localStorage.getItem(`nurseNotes_${i}`) || '[]');
        notes.forEach(note => {
          allNotes.push({
            bed: i,
            ...note
          });
        });
      }

      allNotes.sort((a, b) => new Date(b.time) - new Date(a.time));

      const modal = document.createElement('div');
      modal.className = 'modal';
      modal.style.display = 'flex';

      let notesHTML = '';
      if (allNotes.length > 0) {
        allNotes.slice(0, 15).forEach((note, index) => {
          notesHTML += `
            <div style="
              background: white;
              border-radius: 12px;
              padding: 18px;
              margin: 10px 0;
              border-left: 4px solid #0ea5e9;
              box-shadow: 0 2px 8px rgba(0,0,0,0.1);
              transition: all 0.3s ease;
            ">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                <div style="
                  background: linear-gradient(135deg, #0ea5e9, #0284c7);
                  color: white;
                  padding: 4px 12px;
                  border-radius: 15px;
                  font-size: 12px;
                  font-weight: 600;
                ">üõèÔ∏è ‡πÄ‡∏ï‡∏µ‡∏¢‡∏á ${note.bed}</div>
                <div style="font-size: 11px; color: #64748b;">${note.time}</div>
              </div>
              
              <div style="
                background: linear-gradient(135deg, #f8fafc, #f1f5f9);
                padding: 12px;
                border-radius: 8px;
                margin-bottom: 10px;
                line-height: 1.5;
                color: #1e293b;
              ">
                ${note.content}
              </div>
              
              <div style="text-align: right; font-size: 11px; color: #64748b;">
                üë§ ${note.author}
              </div>
            </div>
          `;
        });
      } else {
        notesHTML = `
          <div style="
            text-align: center;
            padding: 40px 20px;
            color: #64748b;
            font-style: italic;
            background: linear-gradient(135deg, #f8fafc, #f1f5f9);
            border-radius: 15px;
            border: 2px dashed #cbd5e1;
          ">
            <div style="font-size: 48px; margin-bottom: 15px;">üìù</div>
            <div style="font-size: 18px; font-weight: 600; margin-bottom: 8px;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</div>
            <div style="font-size: 14px;">‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏î‡∏π‡πÅ‡∏•‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢</div>
          </div>
        `;
      }

      modal.innerHTML = `
        <div class="modal-content" style="max-width: 700px; max-height: 90vh; overflow-y: auto;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; position: sticky; top: 0; background: white; z-index: 10; padding-bottom: 15px; border-bottom: 2px solid #f1f5f9;">
            <h3 style="margin: 0; color: #1e293b;">üìù ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î (${allNotes.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£)</h3>
            <button onclick="this.closest('.modal').remove()" style="
              background: #ef4444;
              color: white;
              border: none;
              padding: 8px 12px;
              border-radius: 8px;
              cursor: pointer;
              font-size: 16px;
              transition: all 0.3s ease;
            ">‚úï</button>
          </div>
          
          <div style="max-height: 500px; overflow-y: auto;">
            ${notesHTML}
          </div>

          <div style="margin-top: 20px; text-align: center; position: sticky; bottom: 0; background: white; padding-top: 15px; border-top: 2px solid #f1f5f9;">
            <button class="btn btn-primary" onclick="this.closest('.modal').remove()">‡∏õ‡∏¥‡∏î</button>
          </div>
        </div>
      `;

      document.body.appendChild(modal);
    }

    function showIOSummary() {
      let totalInput = 0;
      let totalOutput = 0;
      let recordCount = 0;
      let bedSummaries = [];

      for (let i = 1; i <= 8; i++) {
        const ioRecords = JSON.parse(localStorage.getItem(`io_records_bed_${i}`) || '[]');
        const patientData = JSON.parse(localStorage.getItem(`ir_data_bed_${i}`) || 'null');
        
        let bedInput = 0;
        let bedOutput = 0;
        
        ioRecords.forEach(record => {
          bedInput += record.totalIn || 0;
          bedOutput += record.totalOut || 0;
          totalInput += record.totalIn || 0;
          totalOutput += record.totalOut || 0;
          recordCount++;
        });

        if (ioRecords.length > 0) {
          const bedBalance = bedInput - bedOutput;
          bedSummaries.push({
            bed: i,
            patient: patientData ? patientData.patient_id : '‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö',
            input: bedInput,
            output: bedOutput,
            balance: bedBalance,
            recordCount: ioRecords.length
          });
        }
      }

      const totalBalance = totalInput - totalOutput;

      const modal = document.createElement('div');
      modal.className = 'modal';
      modal.style.display = 'flex';

      let bedsHTML = '';
      if (bedSummaries.length > 0) {
        bedSummaries.forEach(bed => {
          const balanceColor = bed.balance >= 0 ? '#22c55e' : '#ef4444';
          bedsHTML += `
            <div style="
              background: white;
              border-radius: 12px;
              padding: 18px;
              margin: 10px 0;
              border-left: 4px solid ${balanceColor};
              box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            ">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <div style="font-weight: 600; color: #1e293b;">üõèÔ∏è ‡πÄ‡∏ï‡∏µ‡∏¢‡∏á ${bed.bed}</div>
                <div style="
                  background: ${balanceColor};
                  color: white;
                  padding: 4px 12px;
                  border-radius: 15px;
                  font-size: 12px;
                  font-weight: 600;
                ">${bed.recordCount} ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</div>
              </div>
              
              <div style="font-size: 14px; color: #64748b; margin-bottom: 15px;">
                üë§ ${bed.patient}
              </div>

              <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px;">
                <div style="text-align: center; background: linear-gradient(135deg, #ecfdf5, #d1fae5); padding: 12px; border-radius: 8px;">
                  <div style="font-size: 16px; font-weight: 700; color: #22c55e;">${bed.input}</div>
                  <div style="font-size: 11px; color: #166534;">INPUT (mL)</div>
                </div>
                <div style="text-align: center; background: linear-gradient(135deg, #fef2f2, #fee2e2); padding: 12px; border-radius: 8px;">
                  <div style="font-size: 16px; font-weight: 700; color: #ef4444;">${bed.output}</div>
                  <div style="font-size: 11px; color: #991b1b;">OUTPUT (mL)</div>
                </div>
                <div style="text-align: center; background: linear-gradient(135deg, #f8fafc, #f1f5f9); padding: 12px; border-radius: 8px;">
                  <div style="font-size: 16px; font-weight: 700; color: ${balanceColor};">
                    ${bed.balance > 0 ? '+' : ''}${bed.balance}
                  </div>
                  <div style="font-size: 11px; color: #64748b;">BALANCE (mL)</div>
                </div>
              </div>
            </div>
          `;
        });
      } else {
        bedsHTML = `
          <div style="
            text-align: center;
            padding: 40px 20px;
            color: #64748b;
            font-style: italic;
            background: linear-gradient(135deg, #f8fafc, #f1f5f9);
            border-radius: 15px;
            border: 2px dashed #cbd5e1;
          ">
            <div style="font-size: 48px; margin-bottom: 15px;">üíß</div>
            <div style="font-size: 18px; font-weight: 600; margin-bottom: 8px;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å I/O</div>
            <div style="font-size: 14px;">‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≤‡∏£‡∏ô‡πâ‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤-‡∏≠‡∏≠‡∏Å</div>
          </div>
        `;
      }

      const balanceColor = totalBalance >= 0 ? '#22c55e' : '#ef4444';

      modal.innerHTML = `
        <div class="modal-content" style="max-width: 700px; max-height: 90vh; overflow-y: auto;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; position: sticky; top: 0; background: white; z-index: 10; padding-bottom: 15px; border-bottom: 2px solid #f1f5f9;">
            <h3 style="margin: 0; color: #1e293b;">üíß ‡∏™‡∏£‡∏∏‡∏õ I/O ‡∏£‡∏∞‡∏ö‡∏ö</h3>
            <button onclick="this.closest('.modal').remove()" style="
              background: #ef4444;
              color: white;
              border: none;
              padding: 8px 12px;
              border-radius: 8px;
              cursor: pointer;
              font-size: 16px;
              transition: all 0.3s ease;
            ">‚úï</button>
          </div>

          <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 25px;">
            <div style="background: linear-gradient(135deg, #ecfdf5, #d1fae5); padding: 20px; border-radius: 12px; text-align: center;">
              <div style="font-size: 24px; font-weight: 700; color: #22c55e;">${totalInput}</div>
              <div style="font-size: 12px; color: #166534;">INPUT ‡∏£‡∏ß‡∏° (mL)</div>
            </div>
            <div style="background: linear-gradient(135deg, #fef2f2, #fee2e2); padding: 20px; border-radius: 12px; text-align: center;">
              <div style="font-size: 24px; font-weight: 700; color: #ef4444;">${totalOutput}</div>
              <div style="font-size: 12px; color: #991b1b;">OUTPUT ‡∏£‡∏ß‡∏° (mL)</div>
            </div>
            <div style="background: linear-gradient(135deg, #f8fafc, #f1f5f9); padding: 20px; border-radius: 12px; text-align: center;">
              <div style="font-size: 24px; font-weight: 700; color: ${balanceColor};">
                ${totalBalance > 0 ? '+' : ''}${totalBalance}
              </div>
              <div style="font-size: 12px; color: #64748b;">BALANCE ‡∏£‡∏ß‡∏° (mL)</div>
            </div>
          </div>
          
          <div style="max-height: 400px; overflow-y: auto;">
            ${bedsHTML}
          </div>

          <div style="margin-top: 20px; text-align: center; position: sticky; bottom: 0; background: white; padding-top: 15px; border-top: 2px solid #f1f5f9;">
            <div style="font-size: 12px; color: #64748b; margin-bottom: 10px;">
              ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: ${recordCount} ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
            </div>
            <button class="btn btn-primary" onclick="this.closest('.modal').remove()">‡∏õ‡∏¥‡∏î</button>
          </div>
        </div>
      `;

      document.body.appendChild(modal);
    }

    function showVitalsSummary() {
      let details = '‡∏™‡∏£‡∏∏‡∏õ Vital Signs:\n\n';
      let count = 0;

      for (let i = 1; i <= 8; i++) {
        const vitals = JSON.parse(localStorage.getItem(`vitals_bed_${i}`) || 'null');
        if (vitals) {
          count++;
          details += `‡πÄ‡∏ï‡∏µ‡∏¢‡∏á ${i}:\n`;
          details += `BP: ${vitals.systolic}/${vitals.diastolic}\n`;
          details += `HR: ${vitals.heartRate} bpm\n`;
          details += `Temp: ${vitals.temperature}¬∞C\n`;
          details += `O2: ${vitals.oxygen}%\n\n`;
        }
      }

      if (count === 0) {
        details += '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Vital Signs';
      }

      alert(details);
    }

    function showMedicationSummary() {
      let details = '‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Å‡∏≤‡∏£‡∏¢‡∏≤:\n\n';
      let totalMeds = 0;

      for (let i = 1; i <= 8; i++) {
        const medications = JSON.parse(localStorage.getItem(`medications_bed_${i}`) || '[]');
        if (medications.length > 0) {
          details += `‡πÄ‡∏ï‡∏µ‡∏¢‡∏á ${i}:\n`;
          medications.forEach(med => {
            details += `- ${med.name} ${med.dose} ‡πÄ‡∏ß‡∏•‡∏≤ ${med.time}\n`;
            totalMeds++;
          });
          details += '\n';
        }
      }

      if (totalMeds === 0) {
        details += '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Å‡∏≤‡∏£‡∏¢‡∏≤';
      } else {
        details = `‡∏¢‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: ${totalMeds} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£\n\n` + details;
      }

      alert(details);
    }

    function showAlertsDetails() {
      let alerts = [];

      for (let i = 1; i <= 8; i++) {
        const vitals = JSON.parse(localStorage.getItem(`vitals_bed_${i}`) || 'null');
        const patientData = JSON.parse(localStorage.getItem(`ir_data_bed_${i}`) || 'null');

        if (vitals) {
          if (vitals.systolic > 140 || vitals.diastolic > 90) {
            alerts.push(`‡πÄ‡∏ï‡∏µ‡∏¢‡∏á ${i}: ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏±‡∏ô‡πÇ‡∏•‡∏´‡∏¥‡∏ï‡∏™‡∏π‡∏á (${vitals.systolic}/${vitals.diastolic})`);
          }
          if (vitals.heartRate > 100 || vitals.heartRate < 60) {
            alerts.push(`‡πÄ‡∏ï‡∏µ‡∏¢‡∏á ${i}: ‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏ï‡πâ‡∏ô‡∏Ç‡∏≠‡∏á‡∏´‡∏±‡∏ß‡πÉ‡∏à‡∏ú‡∏¥‡∏î‡∏õ‡∏Å‡∏ï‡∏¥ (${vitals.heartRate})`);
          }
          if (vitals.temperature > 37.5) {
            alerts.push(`‡πÄ‡∏ï‡∏µ‡∏¢‡∏á ${i}: ‡∏°‡∏µ‡πÑ‡∏Ç‡πâ (${vitals.temperature}¬∞C)`);
          }
          if (vitals.oxygen < 95) {
            alerts.push(`‡πÄ‡∏ï‡∏µ‡∏¢‡∏á ${i}: ‡∏≠‡∏≠‡∏Å‡∏ã‡∏¥‡πÄ‡∏à‡∏ô‡∏ï‡πà‡∏≥ (${vitals.oxygen}%)`);
          }
        }
      }

      let details = alerts.length > 0 ? 
        `‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô (${alerts.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£):\n\n${alerts.join('\n')}` :
        '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô';

      alert(details);
    }

    function openSummaryModal() {
      // ‡∏™‡∏£‡πâ‡∏≤‡∏á modal ‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏£‡∏≤‡∏¢‡πÄ‡∏ï‡∏µ‡∏¢‡∏á
      const modal = document.createElement('div');
      modal.className = 'modal';
      modal.style.display = 'flex';

      let bedsInfo = [];
      let totalActive = 0;
      let totalCritical = 0;

      // ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏ï‡πà‡∏•‡∏∞‡πÄ‡∏ï‡∏µ‡∏¢‡∏á
      for (let i = 1; i <= 8; i++) {
        const patientData = JSON.parse(localStorage.getItem(`ir_data_bed_${i}`) || 'null');
        const vitals = JSON.parse(localStorage.getItem(`vitals_bed_${i}`) || 'null');
        const medications = JSON.parse(localStorage.getItem(`medications_bed_${i}`) || '[]');
        const ioRecords = JSON.parse(localStorage.getItem(`io_records_bed_${i}`) || '[]');
        const notes = JSON.parse(localStorage.getItem(`nurseNotes_${i}`) || '[]');

        let ioBalance = 0;
        ioRecords.forEach(record => {
          ioBalance += record.balance || 0;
        });

        let status = '‡∏ß‡πà‡∏≤‡∏á';
        let statusColor = '#94a3b8';
        let alerts = [];

        if (patientData) {
          totalActive++;
          status = '‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô';
          statusColor = '#22c55e';

          if (vitals) {
            if (vitals.systolic > 160 || vitals.diastolic > 100) {
              alerts.push('‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏±‡∏ô‡∏™‡∏π‡∏á‡∏°‡∏≤‡∏Å');
              statusColor = '#ef4444';
            }
            if (vitals.heartRate > 120 || vitals.heartRate < 50) {
              alerts.push('‡∏ä‡∏µ‡∏û‡∏à‡∏£‡∏ú‡∏¥‡∏î‡∏õ‡∏Å‡∏ï‡∏¥');
              statusColor = '#ef4444';
            }
            if (vitals.temperature > 38.5) {
              alerts.push('‡πÑ‡∏Ç‡πâ‡∏™‡∏π‡∏á');
              statusColor = '#ef4444';
            }
            if (vitals.oxygen < 90) {
              alerts.push('‡∏≠‡∏≠‡∏Å‡∏ã‡∏¥‡πÄ‡∏à‡∏ô‡∏ï‡πà‡∏≥‡∏°‡∏≤‡∏Å');
              statusColor = '#ef4444';
            }
          }

          if (alerts.length > 0) {
            totalCritical++;
          }
        }

        bedsInfo.push({
          bedNumber: i,
          patient: patientData,
          vitals: vitals,
          medicationCount: medications.length,
          ioBalance: ioBalance,
          notesCount: notes.length,
          status: status,
          statusColor: statusColor,
          alerts: alerts
        });
      }

      // ‡∏™‡∏£‡πâ‡∏≤‡∏á HTML ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏ï‡πà‡∏•‡∏∞‡πÄ‡∏ï‡∏µ‡∏¢‡∏á
      let bedsHTML = '';
      bedsInfo.forEach(bed => {
        bedsHTML += `
          <div class="bed-summary-card" style="
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin: 10px 0;
            border: 2px solid ${bed.statusColor};
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
          ">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
              <h4 style="color: #1e293b; margin: 0;">üõèÔ∏è ‡πÄ‡∏ï‡∏µ‡∏¢‡∏á ${bed.bedNumber}</h4>
              <div style="
                background: ${bed.statusColor};
                color: white;
                padding: 6px 12px;
                border-radius: 20px;
                font-size: 12px;
                font-weight: 600;
              ">${bed.status}</div>
            </div>

            ${bed.patient ? `
              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                <div>
                  <div style="font-size: 12px; color: #64748b;">‡∏£‡∏´‡∏±‡∏™‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢</div>
                  <div style="font-weight: 600; color: #1e293b;">${bed.patient.patient_id}</div>
                </div>
                <div>
                  <div style="font-size: 12px; color: #64748b;">‡∏¢‡∏≤</div>
                  <div style="font-weight: 600; color: #1e293b;">${bed.patient.medication}</div>
                </div>
                <div>
                  <div style="font-size: 12px; color: #64748b;">‡∏≠‡∏±‡∏ï‡∏£‡∏≤</div>
                  <div style="font-weight: 600; color: #0ea5e9;">${bed.patient.rate} ‡∏î‡∏£‡∏≠‡∏õ/‡∏ô‡∏≤‡∏ó‡∏µ</div>
                </div>
                <div>
                  <div style="font-size: 12px; color: #64748b;">‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì</div>
                  <div style="font-weight: 600; color: #0ea5e9;">${bed.patient.volume} mL</div>
                </div>
              </div>

              ${bed.vitals ? `
                <div style="
                  background: linear-gradient(135deg, #fef3c7, #fde68a);
                  padding: 12px;
                  border-radius: 8px;
                  margin-bottom: 15px;
                ">
                  <div style="font-size: 12px; font-weight: 600; color: #92400e; margin-bottom: 8px;">ü©∫ Vital Signs</div>
                  <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; font-size: 11px;">
                    <div>BP: <strong>${bed.vitals.systolic}/${bed.vitals.diastolic}</strong></div>
                    <div>HR: <strong>${bed.vitals.heartRate}</strong> bpm</div>
                    <div>Temp: <strong>${bed.vitals.temperature}</strong>¬∞C</div>
                    <div>O2: <strong>${bed.vitals.oxygen}</strong>%</div>
                  </div>
                </div>
              ` : ''}

              <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 15px;">
                <div style="text-align: center; background: #f8fafc; padding: 8px; border-radius: 6px;">
                  <div style="font-size: 16px; font-weight: 700; color: #0ea5e9;">${bed.medicationCount}</div>
                  <div style="font-size: 10px; color: #64748b;">‡∏¢‡∏≤</div>
                </div>
                <div style="text-align: center; background: #f8fafc; padding: 8px; border-radius: 6px;">
                  <div style="font-size: 16px; font-weight: 700; color: ${bed.ioBalance >= 0 ? '#22c55e' : '#ef4444'};">
                    ${bed.ioBalance > 0 ? '+' : ''}${bed.ioBalance}
                  </div>
                  <div style="font-size: 10px; color: #64748b;">I/O Balance</div>
                </div>
                <div style="text-align: center; background: #f8fafc; padding: 8px; border-radius: 6px;">
                  <div style="font-size: 16px; font-weight: 700; color: #8b5cf6;">${bed.notesCount}</div>
                  <div style="font-size: 10px; color: #64748b;">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</div>
                </div>
              </div>

              ${bed.alerts.length > 0 ? `
                <div style="
                  background: linear-gradient(135deg, #fef2f2, #fee2e2);
                  border: 1px solid #ef4444;
                  padding: 10px;
                  border-radius: 8px;
                ">
                  <div style="font-size: 12px; font-weight: 600; color: #991b1b; margin-bottom: 5px;">‚ö†Ô∏è ‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô</div>
                  <div style="font-size: 11px; color: #991b1b;">
                    ${bed.alerts.join(', ')}
                  </div>
                </div>
              ` : ''}
            ` : `
              <div style="
                text-align: center;
                padding: 20px;
                color: #64748b;
                font-style: italic;
                background: #f8fafc;
                border-radius: 8px;
              ">
                ‡πÄ‡∏ï‡∏µ‡∏¢‡∏á‡∏ß‡πà‡∏≤‡∏á - ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏£‡∏±‡∏ö‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢
              </div>
            `}
          </div>
        `;
      });

      modal.innerHTML = `
        <div class="modal-content" style="max-width: 800px; max-height: 90vh; overflow-y: auto;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; position: sticky; top: 0; background: white; z-index: 10; padding-bottom: 15px; border-bottom: 2px solid #f1f5f9;">
            <h3 style="margin: 0;">üìä ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ß‡∏±‡∏ô - ‡∏£‡∏≤‡∏¢‡πÄ‡∏ï‡∏µ‡∏¢‡∏á</h3>
            <button onclick="this.closest('.modal').remove()" style="
              background: #ef4444;
              color: white;
              border: none;
              padding: 8px 12px;
              border-radius: 8px;
              cursor: pointer;
              font-size: 16px;
            ">‚úï</button>
          </div>

          <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 25px;">
            <div style="background: linear-gradient(135deg, #f0f9ff, #e0f2fe); padding: 20px; border-radius: 12px; text-align: center;">
              <div style="font-size: 24px; font-weight: 700; color: #0ea5e9;">${totalActive}</div>
              <div style="font-size: 12px; color: #64748b;">‡πÄ‡∏ï‡∏µ‡∏¢‡∏á‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</div>
            </div>
            <div style="background: linear-gradient(135deg, ${totalCritical > 0 ? '#fef2f2, #fee2e2' : '#f0fdf4, #dcfce7'}); padding: 20px; border-radius: 12px; text-align: center;">
              <div style="font-size: 24px; font-weight: 700; color: ${totalCritical > 0 ? '#ef4444' : '#22c55e'};">${totalCritical}</div>
              <div style="font-size: 12px; color: #64748b;">‡πÄ‡∏ï‡∏µ‡∏¢‡∏á‡∏ß‡∏¥‡∏Å‡∏§‡∏ï</div>
            </div>
            <div style="background: linear-gradient(135deg, #fafafa, #f5f5f5); padding: 20px; border-radius: 12px; text-align: center;">
              <div style="font-size: 24px; font-weight: 700; color: #64748b;">${8 - totalActive}</div>
              <div style="font-size: 12px; color: #64748b;">‡πÄ‡∏ï‡∏µ‡∏¢‡∏á‡∏ß‡πà‡∏≤‡∏á</div>
            </div>
          </div>

          <div style="margin-bottom: 20px; padding: 15px; background: #f8fafc; border-radius: 10px; border-left: 4px solid #0ea5e9;">
            <div style="font-size: 12px; color: #64748b;">
              üìÖ ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: ${new Date().toLocaleDateString('th-TH')} | 
              ‚è∞ ‡πÄ‡∏ß‡∏•‡∏≤: ${new Date().toLocaleTimeString('th-TH')} | 
              üë§ ‡∏ú‡∏π‡πâ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô: ${currentUser.fullname}
            </div>
          </div>

          <div style="max-height: 500px; overflow-y: auto;">
            ${bedsHTML}
          </div>

          <div style="margin-top: 20px; text-align: center; position: sticky; bottom: 0; background: white; padding-top: 15px; border-top: 2px solid #f1f5f9;">
            <button class="btn btn-secondary" onclick="printSummaryReport()" style="margin-right: 10px;">üñ®Ô∏è ‡∏û‡∏¥‡∏°‡∏û‡πå‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</button>
            <button class="btn btn-primary" onclick="this.closest('.modal').remove()">‡∏õ‡∏¥‡∏î</button>
          </div>
        </div>
      `;

      document.body.appendChild(modal);
    }

    function printSummaryReport() {
      window.print();
    }

    function openResetModal() {
      document.getElementById('resetModal').style.display = 'flex';
    }

    function resetAllData() {
      if (!confirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î? ‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏ó‡∏≥‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏î‡πâ')) return;

      for (let i = 1; i <= 99; i++) {
        localStorage.removeItem(`ir_data_bed_${i}`);
        localStorage.removeItem(`nurseNotes_${i}`);
        localStorage.removeItem(`io_records_bed_${i}`);
        localStorage.removeItem(`vitals_bed_${i}`);
        localStorage.removeItem(`medications_bed_${i}`);
      }

      closeModal('resetModal');
      alert('‚úÖ ‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß');
      location.reload();
    }

    function logout() {
      if (confirm('‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö?')) {
        sessionStorage.removeItem('currentUser');
        window.location.href = 'index.html';
      }
    }

    // ‡∏õ‡∏¥‡∏î modal ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ô‡∏≠‡∏Å‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà
    document.addEventListener('click', function(e) {
      if (e.target.classList.contains('modal')) {
        e.target.style.display = 'none';
      }
    });
  </script>
</body>
</html>