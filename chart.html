<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>NurseBuddy | Chart เตียงที่ ${bedId}</title>
  <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="script.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'Sarabun', sans-serif;
      background: linear-gradient(135deg, #f0f7ff, #f7fdf9);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
    }

    .header {
      background: linear-gradient(135deg, #4caf50, #66bb6a);
      color: white;
      padding: 25px;
      border-radius: 20px;
      margin-bottom: 25px;
      box-shadow: 0 10px 30px rgba(76, 175, 80, 0.3);
      position: relative;
      overflow: hidden;
    }

    .header::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(45deg, transparent 30%, rgba(255,255,255,0.1) 40%, transparent 50%);
      animation: shimmer 3s infinite;
    }

    @keyframes shimmer {
      0% { transform: translateX(-100%); }
      100% { transform: translateX(100%); }
    }

    .header h1 {
      font-size: 26px;
      margin-bottom: 8px;
      font-weight: 700;
    }

    .header p {
      font-size: 15px;
      opacity: 0.9;
    }

    .back-btn {
      background: rgba(255,255,255,0.2);
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 10px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      margin-bottom: 15px;
      transition: all 0.3s ease;
      border: 1px solid rgba(255,255,255,0.3);
    }

    .back-btn:hover {
      background: rgba(255,255,255,0.3);
      transform: translateY(-2px);
    }

    .grid-container {
      display: grid;
      grid-template-columns: 2fr 1fr;
      gap: 25px;
      margin-bottom: 25px;
    }

    .card {
      background: white;
      border-radius: 20px;
      box-shadow: 0 8px 25px rgba(0,0,0,0.1);
      overflow: hidden;
      transition: transform 0.3s ease;
    }

    .card:hover {
      transform: translateY(-5px);
    }

    .card-header {
      background: linear-gradient(135deg, #e8f5e9, #f3e5f5);
      padding: 20px;
      border-bottom: 1px solid #e0e0e0;
    }

    .card-title {
      font-size: 18px;
      font-weight: 600;
      color: #2e7d32;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .card-body {
      padding: 25px;
    }

    /* สีสันสำหรับการแสดงข้อมูลยา */
    .medication-display {
      background: linear-gradient(135deg, #fff3e0, #ffecb3);
      padding: 20px;
      border-radius: 15px;
      border: 3px solid #ff9800;
      margin-bottom: 20px;
      box-shadow: 0 5px 15px rgba(255, 152, 0, 0.2);
    }

    .medication-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }

    .medication-title {
      font-weight: bold;
      color: #e65100;
      font-size: 18px;
    }

    .medication-time {
      font-size: 13px;
      color: #bf360c;
      background: rgba(255,255,255,0.7);
      padding: 5px 10px;
      border-radius: 8px;
    }

    .medication-grid {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 15px;
      text-align: center;
    }

    .medication-item {
      background: white;
      padding: 15px 10px;
      border-radius: 12px;
      border: 2px solid #e0e0e0;
      transition: transform 0.2s ease;
    }

    .medication-item:hover {
      transform: translateY(-3px);
    }

    .medication-item.patient {
      background: linear-gradient(135deg, #e8f5e9, #c8e6c9);
      border-color: #4caf50;
    }

    .medication-item.med {
      background: linear-gradient(135deg, #e3f2fd, #bbdefb);
      border-color: #2196f3;
    }

    .medication-item.rate {
      background: linear-gradient(135deg, #fce4ec, #f8bbd9);
      border-color: #e91e63;
    }

    .medication-label {
      font-size: 12px;
      font-weight: bold;
      color: #666;
      margin-bottom: 8px;
      text-transform: uppercase;
    }

    .medication-value {
      font-size: 18px;
      font-weight: bold;
      color: #333;
    }

    /* IV Calculator สีสันสวยงาม */
    .iv-calculator-card {
      background: linear-gradient(135deg, #f1f8e9, #e8f5e8);
      border-radius: 20px;
      padding: 25px;
      margin-bottom: 25px;
      border: 3px solid #4caf50;
      box-shadow: 0 8px 25px rgba(76, 175, 80, 0.2);
    }

    .calc-section {
      background: white;
      border-radius: 15px;
      padding: 20px;
      margin-bottom: 20px;
      border-left: 5px solid #4caf50;
      box-shadow: 0 3px 10px rgba(0,0,0,0.1);
    }

    .calc-title {
      font-size: 20px;
      font-weight: 700;
      color: #2e7d32;
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .input-row {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 20px;
      margin-bottom: 20px;
    }

    .input-group {
      display: flex;
      flex-direction: column;
    }

    .input-group label {
      font-size: 14px;
      font-weight: 600;
      color: #333;
      margin-bottom: 8px;
    }

    .input-group input, .input-group select {
      padding: 12px 15px;
      border: 2px solid #e0e0e0;
      border-radius: 10px;
      font-size: 14px;
      transition: all 0.3s ease;
      background: white;
    }

    .input-group input:focus, .input-group select:focus {
      border-color: #4caf50;
      outline: none;
      box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.1);
    }

    .calc-button {
      background: linear-gradient(135deg, #4caf50, #66bb6a);
      color: white;
      border: none;
      padding: 15px 35px;
      border-radius: 12px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(76, 175, 80, 0.3);
    }

    .calc-button:hover {
      transform: translateY(-3px);
      box-shadow: 0 6px 20px rgba(76, 175, 80, 0.4);
    }

    .results-section {
      background: linear-gradient(135deg, #e8f5e8, #f1f8e9);
      border-radius: 15px;
      padding: 20px;
      margin-top: 20px;
      border: 2px solid #4caf50;
    }

    .result-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
      margin-bottom: 20px;
    }

    .result-item {
      background: white;
      padding: 15px;
      border-radius: 12px;
      border-left: 4px solid #4caf50;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .result-item.highlight {
      background: linear-gradient(135deg, #fff3cd, #ffeaa7);
      border-left-color: #ffc107;
    }

    .result-item.warning {
      background: linear-gradient(135deg, #f8d7da, #fab1a0);
      border-left-color: #dc3545;
    }

    .result-label {
      font-size: 12px;
      color: #666;
      margin-bottom: 5px;
      font-weight: 600;
      text-transform: uppercase;
    }

    .result-value {
      font-size: 18px;
      font-weight: bold;
      color: #333;
    }

    .status-indicator {
      display: inline-block;
      width: 12px;
      height: 12px;
      border-radius: 50%;
      margin-left: 10px;
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.2); }
      100% { transform: scale(1); }
    }

    .status-active { background: #4caf50; }
    .status-error { background: #f44336; }
    .status-warning { background: #ff9800; }

    .chart-container {
      height: 350px;
      margin-bottom: 20px;
      background: white;
      border-radius: 15px;
      padding: 15px;
    }

    /* I/O Section สีสันสวยงาม */
    .io-section {
      background: linear-gradient(135deg, #e3f2fd, #f3e5f5);
      border-radius: 20px;
      padding: 25px;
      margin-bottom: 25px;
      border: 3px solid #2196f3;
      box-shadow: 0 8px 25px rgba(33, 150, 243, 0.2);
    }

    .io-form {
      background: white;
      padding: 25px;
      border-radius: 15px;
      margin-bottom: 20px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }

    .io-input-section {
      padding: 20px;
      border-radius: 15px;
      margin-bottom: 15px;
    }

    .io-input-section.input {
      background: linear-gradient(135deg, #e8f5e9, #f1f8e9);
      border-left: 5px solid #4caf50;
    }

    .io-input-section.output {
      background: linear-gradient(135deg, #ffebee, #fce4ec);
      border-left: 5px solid #f44336;
    }

    .io-input-section.time {
      background: linear-gradient(135deg, #fff3e0, #ffecb3);
      border-left: 5px solid #ff9800;
    }

    .io-input-section h4 {
      margin-bottom: 15px;
      font-size: 18px;
      font-weight: 600;
    }

    .io-input-group {
      margin-bottom: 15px;
    }

    .io-input-group label {
      display: block;
      margin-bottom: 5px;
      font-weight: 600;
      color: #333;
    }

    .io-input-group input, .io-input-group textarea {
      width: 100%;
      padding: 10px 12px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 14px;
      transition: border-color 0.3s ease;
    }

    .io-input-group input:focus, .io-input-group textarea:focus {
      border-color: #4caf50;
      outline: none;
    }

    .io-balance-display {
      background: linear-gradient(135deg, #f8f9fa, #e9ecef);
      padding: 20px;
      border-radius: 15px;
      margin-top: 20px;
      text-align: center;
      border: 2px solid #dee2e6;
    }

    .io-balance-grid {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 15px;
      margin-top: 15px;
    }

    .io-balance-item {
      padding: 15px;
      border-radius: 12px;
      font-weight: bold;
    }

    .io-balance-item.input {
      background: linear-gradient(135deg, #e8f5e9, #c8e6c9);
      color: #2e7d32;
    }

    .io-balance-item.output {
      background: linear-gradient(135deg, #ffebee, #ffcdd2);
      color: #c62828;
    }

    .io-balance-item.balance {
      background: linear-gradient(135deg, #e3f2fd, #bbdefb);
      color: #1976d2;
    }

    /* Notes Section - Enhanced Infographic Style */
    .notes-section {
      background: linear-gradient(135deg, #ffffff, #f8fdff);
      border-radius: 25px;
      padding: 30px;
      box-shadow: 0 15px 40px rgba(0,0,0,0.12);
      border: 2px solid rgba(76, 175, 80, 0.1);
      position: relative;
      overflow: hidden;
    }

    .notes-section::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 6px;
      background: linear-gradient(90deg, #4caf50, #2196f3, #ff9800, #e91e63, #9c27b0);
      background-size: 300% 100%;
      animation: gradientShift 5s ease-in-out infinite;
    }

    @keyframes gradientShift {
      0%, 100% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
    }

    .notes-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 25px;
      position: relative;
    }

    .notes-header h3 {
      font-size: 24px;
      font-weight: 700;
      background: linear-gradient(135deg, #2e7d32, #4caf50);
      -webkit-background-clip: text;
      background-clip: text;
      -webkit-text-fill-color: transparent;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .notes-count-badge {
      background: linear-gradient(135deg, #ff9800, #ffc107);
      color: white;
      padding: 6px 14px;
      border-radius: 20px;
      font-size: 14px;
      font-weight: 600;
      box-shadow: 0 4px 12px rgba(255, 152, 0, 0.3);
      animation: countPulse 2s ease-in-out infinite;
    }

    @keyframes countPulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.05); }
    }

    .note-input {
      width: 100%;
      padding: 18px 20px;
      border: 3px solid transparent;
      background: linear-gradient(white, white) padding-box, 
                  linear-gradient(135deg, #4caf50, #2196f3) border-box;
      border-radius: 15px;
      margin-bottom: 18px;
      resize: vertical;
      min-height: 90px;
      font-family: 'Sarabun', sans-serif;
      font-size: 14px;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(0,0,0,0.08);
    }

    .note-input:focus {
      outline: none;
      box-shadow: 0 8px 25px rgba(76, 175, 80, 0.2);
      transform: translateY(-2px);
    }

    .add-note-btn {
      background: linear-gradient(135deg, #4caf50, #66bb6a);
      color: white;
      border: none;
      padding: 15px 30px;
      border-radius: 15px;
      cursor: pointer;
      font-weight: 600;
      font-size: 16px;
      transition: all 0.3s ease;
      box-shadow: 0 6px 20px rgba(76, 175, 80, 0.3);
      position: relative;
      overflow: hidden;
    }

    .add-note-btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
      transition: left 0.5s;
    }

    .add-note-btn:hover::before {
      left: 100%;
    }

    .add-note-btn:hover {
      transform: translateY(-3px);
      box-shadow: 0 10px 30px rgba(76, 175, 80, 0.4);
    }

    .note-item {
      background: linear-gradient(135deg, #ffffff, #f8fdff);
      padding: 20px;
      border-radius: 18px;
      margin-bottom: 15px;
      position: relative;
      box-shadow: 0 8px 25px rgba(0,0,0,0.08);
      border: 1px solid rgba(76, 175, 80, 0.1);
      transition: all 0.3s ease;
      overflow: hidden;
    }

    .note-item::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 6px;
      height: 100%;
      background: linear-gradient(135deg, #4caf50, #2196f3);
    }

    .note-item:hover {
      transform: translateY(-3px);
      box-shadow: 0 12px 35px rgba(0,0,0,0.12);
    }

    .note-header-info {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
      flex-wrap: wrap;
      gap: 10px;
    }

    .note-author-badge {
      background: linear-gradient(135deg, #e3f2fd, #bbdefb);
      color: #1976d2;
      padding: 8px 16px;
      border-radius: 12px;
      font-weight: 600;
      font-size: 14px;
      display: flex;
      align-items: center;
      gap: 8px;
      box-shadow: 0 3px 10px rgba(33, 150, 243, 0.2);
    }

    .note-author-badge::before {
      content: '👩‍⚕️';
      font-size: 16px;
    }

    .note-time-badge {
      background: linear-gradient(135deg, #fff3e0, #ffcc02);
      color: #e65100;
      padding: 6px 12px;
      border-radius: 10px;
      font-size: 12px;
      font-weight: 600;
      white-space: nowrap;
      box-shadow: 0 2px 8px rgba(230, 81, 0, 0.2);
    }

    .note-content {
      color: #2e3d55;
      line-height: 1.6;
      font-size: 15px;
      padding: 12px 0;
      position: relative;
    }

    .note-type-indicator {
      position: absolute;
      top: 15px;
      right: 15px;
      padding: 4px 10px;
      border-radius: 8px;
      font-size: 10px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .note-type-medication {
      background: linear-gradient(135deg, #e8f5e9, #c8e6c9);
      color: #2e7d32;
    }

    .note-type-fluid {
      background: linear-gradient(135deg, #e3f2fd, #bbdefb);
      color: #1976d2;
    }

    .note-type-manual {
      background: linear-gradient(135deg, #fce4ec, #f8bbd9);
      color: #c2185b;
    }

    .notes-empty-state {
      text-align: center;
      padding: 40px 20px;
      background: linear-gradient(135deg, #f8f9fa, #e9ecef);
      border-radius: 20px;
      border: 3px dashed rgba(76, 175, 80, 0.3);
      margin-top: 20px;
    }

    .notes-empty-state .empty-icon {
      font-size: 64px;
      margin-bottom: 16px;
      opacity: 0.7;
    }

    .notes-empty-state .empty-title {
      font-size: 18px;
      font-weight: 600;
      color: #666;
      margin-bottom: 8px;
    }

    .notes-empty-state .empty-subtitle {
      font-size: 14px;
      color: #999;
    }

    /* Footer Styles (unchanged) */

    @media (max-width: 768px) {
      .grid-container {
        grid-template-columns: 1fr;
      }

      .input-row {
        grid-template-columns: 1fr;
      }

      .result-grid {
        grid-template-columns: 1fr;
      }

      .io-balance-grid {
        grid-template-columns: 1fr;
      }

      .medication-grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Header -->
    <div class="header">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
        <button class="back-btn" onclick="window.location.href='dashboard.html'">← กลับไปแดชบอร์ด</button>
        <button class="back-btn" onclick="logout()" style="background: rgba(244, 67, 54, 0.2); border-color: rgba(244, 67, 54, 0.3);">🚪 ออกจากระบบ</button>
      </div>
      <h1 id="bedTitle">🏥 Chart เตียงที่ 1</h1>
      <p>ระบบติดตามและบันทึกข้อมูลผู้ป่วยแบบครบวงจร</p>
    </div>

    <!-- Current Status Section (บนสุด) -->
    <div class="card" style="margin-bottom: 25px;">
      <div class="card-header">
        <div class="card-title">
          📡 สถานะปัจจุบัน
          <span class="status-indicator" id="statusDot"></span>
        </div>
      </div>
      <div class="card-body">
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
          <div style="background: linear-gradient(135deg, #e8f5e9, #c8e6c9); padding: 15px; border-radius: 12px; text-align: center;">
            <div style="font-size: 12px; color: #4caf50; font-weight: bold; margin-bottom: 5px;">อัตราปัจจุบัน</div>
            <div id="currentFlow" style="font-size: 20px; font-weight: bold; color: #2e7d32;">25 ดรอป/นาที</div>
          </div>
          <div style="background: linear-gradient(135deg, #e3f2fd, #bbdefb); padding: 15px; border-radius: 12px; text-align: center;">
            <div style="font-size: 12px; color: #1976d2; font-weight: bold; margin-bottom: 5px;">อัตราที่สั่ง</div>
            <div id="orderedFlow" style="font-size: 20px; font-weight: bold; color: #1976d2;">0 ดรอป/นาที</div>
          </div>
        </div>
        <div style="text-align: center; font-size: 12px; color: #666;">
          อัพเดทล่าสุด: <span id="lastUpdate">-</span>
        </div>
        <div id="alarmStatus" style="display: none; background: linear-gradient(135deg, #ffebee, #ffcdd2); padding: 10px; border-radius: 8px; margin-top: 10px; text-align: center; color: #c62828; font-weight: bold;">
          ⚠️ อัตราไม่ตรงตามที่สั่ง!
        </div>
      </div>
    </div>

    <!-- บันทึกข้อมูลยา -->
    <div class="card" style="margin-bottom: 25px;">
      <div class="card-header">
        <div class="card-title">📱 บันทึกข้อมูลยา</div>
      </div>
      <div class="card-body">
        <!-- แสดงข้อมูลยาที่มีอยู่ -->
        <div id="medicationDisplay" style="display: none; margin-bottom: 20px;">
          <div class="medication-display">
            <div class="medication-header">
              <div class="medication-title">💊 ข้อมูลยาและผู้ป่วยปัจจุบัน</div>
              <div class="medication-time" id="medicationTime"></div>
            </div>
            <div class="medication-grid">
              <div class="medication-item patient">
                <div class="medication-label">รหัสผู้ป่วย</div>
                <div class="medication-value" id="currentPatientId">-</div>
              </div>
              <div class="medication-item med">
                <div class="medication-label">ชนิดสารน้ำ</div>
                <div class="medication-value" id="currentMedication">-</div>
              </div>
              <div class="medication-item rate">
                <div class="medication-label">อัตราที่สั่ง</div>
                <div class="medication-value"><span id="currentRate">-</span> ดรอป/นาที</div>
                <div class="medication-value" style="font-size: 14px; margin-top: 5px; color: #666;">
                  ~<span id="currentRatePerSec">-</span> ดรอป/วินาที
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="input-group" style="margin-bottom: 15px;">
          <label>รหัสผู้ป่วย:</label>
          <input type="text" id="patientId" placeholder="เช่น P001234">
        </div>

        <div class="input-group" style="margin-bottom: 15px;">
          <label>เลือกรูปแบบสารน้ำ:</label>
          <select id="medication">
            <option value="Normal Saline">🧪 Normal Saline (0.9% NSS)</option>            <option value="Dextrose 5%">🍯 Dextrose 5% in Water</option>
            <option value="Lactated Ringer's">💧 Lactated Ringer's Solution</option>
            <option value="Dextrose 5% in NSS">🧪 D5NSS</option>
            <option value="Half Normal Saline">💧 0.45% NSS</option>
          </select>
        </div>

        <div class="input-row">
          <div class="input-group">
            <label>ปริมาณ (mL):</label>
            <input type="number" id="volume" placeholder="500" min="50" max="2000" onchange="autoFillCalculator()">
          </div>
          <div class="input-group">
            <label>อัตราที่สั่ง (ดรอป/นาที):</label>
            <input type="number" id="rate" placeholder="20" min="1" max="100" onchange="autoFillCalculator()">
          </div>
        </div>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 15px;">
          <button onclick="saveMedicationData()" id="saveBtn" class="calc-button">💾 บันทึกข้อมูล</button>
          <button onclick="resetBedData()" class="calc-button" style="background: linear-gradient(135deg, #f44336, #e57373);">🗑️ รีเซ็ตข้อมูล</button>
        </div>
      </div>
    </div>

    <!-- เครื่องคำนวณน้ำเกลือ -->
    <div class="iv-calculator-card" style="margin-bottom: 25px;">
      <div class="calc-title">🧮 เครื่องคำนวณน้ำเกลือ</div>

      <div class="calc-section">
        <h4 style="color: #2e7d32; margin-bottom: 15px;">📋 ข้อมูลพื้นฐาน</h4>
        <div class="input-row">
          <div class="input-group">
            <label>ปริมาตรน้ำเกลือ (cc/ml)</label>
            <input type="number" id="totalVolume" placeholder="1000" min="50" max="2000">
          </div>
          <div class="input-group">
            <label>Drop Factor (หยด/cc)</label>
            <select id="dropFactor">
              <option value="15">15 หยด/cc (Macro set)</option>
              <option value="20" selected>20 หยด/cc (Macro set)</option>
              <option value="60">60 หยด/cc (Micro set)</option>
              <option value="10">10 หยด/cc (เด็ก)</option>
            </select>
          </div>
          <div class="input-group">
            <label>น้ำหนักผู้ป่วย (kg)</label>
            <input type="number" id="patientWeight" placeholder="70" min="10" max="200">
          </div>
        </div>
      </div>

      <div class="calc-section">
        <h4 style="color: #2e7d32; margin-bottom: 15px;">⚖️ กรอกข้อมูลอย่างใดอย่างหนึ่ง</h4>
        <div class="input-row">
          <div class="input-group">
            <label>อัตราการหยด (หยด/นาที)</label>
            <input type="number" id="dropPerMin" placeholder="30" min="1" max="200">
          </div>
          <div class="input-group" style="display: flex; align-items: center; justify-content: center;">
            <span style="font-size: 18px; color: #4caf50; font-weight: bold;">หรือ</span>
          </div>
          <div class="input-group">
            <label>อัตราการไหล (cc/hr)</label>
            <input type="number" id="ccPerHr" placeholder="100" min="10" max="1000">
          </div>
        </div>

        <button onclick="calculateIVFlow()" class="calc-button">🧮 คำนวณ</button>
      </div>

      <div id="ivResults" class="results-section" style="display: none;">
        <h4 style="color: #2e7d32; margin-bottom: 15px;">📊 ผลลัพธ์การคำนวณ</h4>
        <div class="result-grid" id="resultsGrid">
          <!-- Results will be populated here -->
        </div>
        <div id="timeResult" style="text-align: center; margin-top: 15px;"></div>
      </div>
    </div>

    <!-- Chart Section (เพิ่มกราฟ) -->
    <div class="card" style="margin-bottom: 25px;">
      <div class="card-header">
        <div class="card-title">📈 กราฟติดตามอัตราการไหล (Real-time)</div>
      </div>
      <div class="card-body">
        <div class="chart-container">
          <canvas id="flowChart"></canvas>
        </div>
        <div style="text-align: center; margin-top: 10px; font-size: 12px; color: #666;">
          กราฟแสดงอัตราการไหลย้อนหลัง 20 นาที | อัพเดททุก 10 วินาที
        </div>
      </div>
    </div>

    <!-- I/O Recording Section -->
    <div class="io-section">
      <div class="notes-header">
        <h3>💧 บันทึก Input/Output (I/O)</h3>
        <button onclick="toggleIOForm()" id="toggleIOBtn" class="add-note-btn">+ บันทึก I/O</button>
      </div>

      <div id="ioForm" class="io-form" style="display: none;">
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 25px; margin-bottom: 20px;">

          <!-- INPUT Section -->
          <div class="io-input-section input">
            <h4 style="color: #2e7d32;">📥 INPUT (สารน้ำเข้า)</h4>

            <div class="io-input-group">
              <label>น้ำดื่ม (mL):</label>
              <input type="number" id="inputWater" placeholder="0" min="0" max="5000">
            </div>

            <div class="io-input-group">
              <label>อาหารเหลว/ทางสายยาง (mL):</label>
              <input type="number" id="inputFood" placeholder="0" min="0" max="2000">
            </div>

            <div class="io-input-group">
              <label>น้ำเกลือ/สารละลายทางเลือด (mL):</label>
              <input type="number" id="inputIV" placeholder="0" min="0" max="3000">
            </div>

            <div class="io-input-group">
              <label>เลือด/ส่วนประกอบเลือด (mL):</label>
              <input type="number" id="inputBlood" placeholder="0" min="0" max="1000">
            </div>

            <div class="io-input-group">
              <label>อื่นๆ (mL):</label>
              <input type="number" id="inputOther" placeholder="0" min="0" max="1000">
            </div>
          </div>

          <!-- OUTPUT Section -->
          <div class="io-input-section output">
            <h4 style="color: #c62828;">📤 OUTPUT (สารน้ำออก)</h4>

            <div class="io-input-group">
              <label>ปัสสาวะ (mL):</label>
              <input type="number" id="outputUrine" placeholder="0" min="0" max="3000">
            </div>

            <div class="io-input-group">
              <label>อาเจียน (mL):</label>
              <input type="number" id="outputVomit" placeholder="0" min="0" max="1000">
            </div>

            <div class="io-input-group">
              <label>น้ำหลั่งจากแผล/Drain (mL):</label>
              <input type="number" id="outputDrain" placeholder="0" min="0" max="500">
            </div>

            <div class="io-input-group">
              <label>อุจจาระเหลว (mL):</label>
              <input type="number" id="outputStool" placeholder="0" min="0" max="1000">
            </div>

            <div class="io-input-group">
              <label>อื่นๆ (mL):</label>
              <input type="number" id="outputOther" placeholder="0" min="0" max="500">
            </div>
          </div>
        </div>

        <!-- Time Selection -->
        <div class="io-input-section time">
          <h4 style="color: #ef6c00;">⏰ เวลาบันทึก</h4>
          <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px;">
            <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
              <input type="radio" name="shift" value="morning" checked>
              <span>🌅 เวรเช้า (06:00-14:00)</span>
            </label>
            <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
              <input type="radio" name="shift" value="afternoon">
              <span>🌤️ เวรบ่าย (14:00-22:00)</span>
            </label>
            <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
              <input type="radio" name="shift" value="night">
              <span>🌙 เวรดึก (22:00-06:00)</span>
            </label>
          </div>
        </div>

        <!-- Notes for I/O -->
        <div class="io-input-group" style="margin-bottom: 20px;">
          <label>หมายเหตุ (สี, กลิ่น, สิ่งผิดปกติ):</label>
          <textarea id="ioNotes" placeholder="เช่น ปัสสาวะใส, ไม่มีกลิ่นผิดปกติ" style="height: 70px;"></textarea>
        </div>

        <!-- Action Buttons -->
        <div style="display: flex; gap: 10px; justify-content: flex-end;">
          <button onclick="calculateIOBalance()" class="calc-button" style="background: linear-gradient(135deg, #2196f3, #64b5f6);">🧮 คำนวณสมดุล</button>
          <button onclick="saveIORecord()" class="calc-button">💾 บันทึก I/O</button>
          <button onclick="toggleIOForm()" class="calc-button" style="background: linear-gradient(135deg, #666, #999);">❌ ยกเลิก</button>
        </div>

        <!-- Balance Display -->
        <div id="ioBalance" class="io-balance-display" style="display: none;">
          <h4 style="color: #333; margin-bottom: 15px;">📊 ผลการคำนวณสมดุลสารน้ำ</h4>
          <div class="io-balance-grid">
            <div class="io-balance-item input">
              <div style="margin-bottom: 8px;">INPUT รวม</div>
              <div id="totalInput" style="font-size: 24px;">0 mL</div>
            </div>
            <div class="io-balance-item output">
              <div style="margin-bottom: 8px;">OUTPUT รวม</div>
              <div id="totalOutput" style="font-size: 24px;">0 mL</div>
            </div>
            <div class="io-balance-item balance">
              <div style="margin-bottom: 8px;">BALANCE</div>
              <div id="fluidBalance" style="font-size: 24px;">0 mL</div>
            </div>
          </div>
        </div>
      </div>

      <!-- I/O History Display -->
      <div id="ioHistory">
        <h4 style="color: #333; margin-bottom: 15px; display: flex; align-items: center; gap: 8px;">
          📋 ประวัติการบันทึก I/O
          <span id="ioHistoryCount" style="font-size: 14px; color: #666;">(0 รายการ)</span>
        </h4>
        <div id="ioHistoryList">
          <!-- I/O records will be displayed here -->
        </div>
      </div>
    </div>

    <!-- Notes Section -->
    <div class="notes-section">
      <div class="notes-header">
        <h3>📝 บันทึกของพยาบาล</h3>
        <span id="notesCount" class="notes-count-badge">0 รายการ</span>
      </div>
      <textarea id="noteInput" class="note-input" placeholder="เพิ่มบันทึก..."></textarea>
      <button onclick="addNote()" class="add-note-btn">+ เพิ่มบันทึก</button>
      <div id="notesList" style="margin-top: 15px;"></div>
    </div>

    <!-- Footer -->
    <div style="text-align: center; margin-top: 30px; padding: 20px; background: linear-gradient(135deg, #f8f9fa, #e9ecef); border-radius: 15px; border: 1px solid #dee2e6; box-shadow: 0 5px 15px rgba(0,0,0,0.1);">
      <div style="font-size: 14px; color: #495057; margin-bottom: 8px; font-weight: 600;">
        💻 พัฒนาโดย <strong style="color: #2e7d32;">จักรพงษ์ แอบไธสง</strong> และคณะ
      </div>
      <div style="font-size: 11px; color: #6c757d; margin-bottom: 5px;">
        NurseBuddy System v0.0.1 beta | ระบบติดตามน้ำเกลืออัจฉริยะ
      </div>
      <div style="font-size: 10px; color: #adb5bd;">
        🏥 เพื่อความปลอดภัยของผู้ป่วยและประสิทธิภาพการพยาบาล
      </div>
    </div>
  </div>

  <script>
    // Global variables
    let bedId = 1;
    let chartInstance = null;
    let currentIRData = null;
    let flowData = [];

    // เมื่อโหลดหน้า
    document.addEventListener('DOMContentLoaded', function() {
      const urlParams = new URLSearchParams(window.location.search);
      bedId = urlParams.get('bed') || 1;
      document.getElementById('bedTitle').textContent = `🏥 Chart เตียงที่ ${bedId}`;

      // เริ่มต้นข้อมูลกราฟ
      initializeFlowData();

      loadExistingData();
      renderNotes();
      loadIOHistory();

      // รอให้ Chart.js โหลดเสร็จก่อน
      setTimeout(() => {
        initializeChart();
        updateStatus();
      }, 100);

      // สร้างข้อมูลจำลองสำหรับการทดสอบ
      generateMockData();

      // Auto-refresh ทุก 10 วินาที
      setInterval(updateStatus, 10000);
    });

    // สร้างข้อมูลจำลองสำหรับการทดสอบ
    function generateMockData() {
      const currentFlowElement = document.getElementById('currentFlow');
      if (currentFlowElement) {
        const mockData = {
          flow: Math.floor(Math.random() * 10) + 20, // 20-30 ดรอป/นาที
          timestamp: new Date().toLocaleTimeString('th-TH')
        };

        currentFlowElement.textContent = `${mockData.flow} ดรอป/นาที`;

        const lastUpdateElement = document.getElementById('lastUpdate');
        if (lastUpdateElement) {
          lastUpdateElement.textContent = mockData.timestamp;
        }
      }
    }

    // ฟังก์ชันเปิด/ปิดฟอร์ม I/O
    function toggleIOForm() {
      const form = document.getElementById('ioForm');
      const btn = document.getElementById('toggleIOBtn');

      if (form && btn) {
        if (form.style.display === 'none' || form.style.display === '') {
          form.style.display = 'block';
          btn.textContent = '❌ ยกเลิก';
        } else {
          form.style.display = 'none';
          btn.textContent = '+ บันทึก I/O';
          clearIOForm();
        }
      }
    }

    // ฟังก์ชันล้างฟอร์ม I/O
    function clearIOForm() {
      const inputs = ['inputWater', 'inputFood', 'inputIV', 'inputBlood', 'inputOther',
                     'outputUrine', 'outputVomit', 'outputDrain', 'outputStool', 'outputOther'];
      inputs.forEach(id => {
        const element = document.getElementById(id);
        if (element) element.value = '';
      });

      const notesElement = document.getElementById('ioNotes');
      if (notesElement) notesElement.value = '';

      const balanceElement = document.getElementById('ioBalance');
      if (balanceElement) balanceElement.style.display = 'none';
    }

    // ฟังก์ชันคำนวณน้ำเกลือ
    function calculateIVFlow() {
      const totalVolume = parseFloat(document.getElementById('totalVolume')?.value) || 0;
      const dropFactor = parseInt(document.getElementById('dropFactor')?.value) || 20;
      const patientWeight = parseFloat(document.getElementById('patientWeight')?.value) || 0;
      const dropPerMin = parseFloat(document.getElementById('dropPerMin')?.value) || 0;
      const ccPerHr = parseFloat(document.getElementById('ccPerHr')?.value) || 0;

      if (!dropPerMin && !ccPerHr) {
        alert('กรุณากรอกอัตราการหยด หรือ อัตราการไหล');
        return;
      }

      // สมมติการคำนวณ
      let calculatedCcPerHr = ccPerHr;
      let calculatedDropPerMin = dropPerMin;

      if (dropPerMin && !ccPerHr) {
        calculatedCcPerHr = (dropPerMin * 60) / dropFactor;
      } else if (ccPerHr && !dropPerMin) {
        calculatedDropPerMin = (ccPerHr * dropFactor) / 60;
      }

      const resultsGrid = document.getElementById('resultsGrid');
      const timeResult = document.getElementById('timeResult');

      if (resultsGrid) {
        let resultsHTML = `
          <div class="result-item">
            <div class="result-label">อัตราการไหล</div>
            <div class="result-value">${calculatedCcPerHr.toFixed(1)} cc/hr</div>
          </div>
          <div class="result-item">
            <div class="result-label">อัตราการหยด</div>
            <div class="result-value">${calculatedDropPerMin.toFixed(1)} หยด/นาที</div>
          </div>
        `;
        resultsGrid.innerHTML = resultsHTML;
      }

      if (timeResult && totalVolume > 0 && calculatedCcPerHr > 0) {
        const timeToFinish = totalVolume / calculatedCcPerHr;
        const hours = Math.floor(timeToFinish);
        const minutes = Math.round((timeToFinish - hours) * 60);

        timeResult.innerHTML = `
          <div class="result-item highlight" style="display: inline-block; padding: 20px 30px;">
            <div class="result-label">⏱️ เวลาที่น้ำเกลือจะหมด</div>
            <div class="result-value" style="font-size: 22px; color: #f57c00;">${hours} ชั่วโมง ${minutes} นาที</div>
          </div>
        `;
      }

      const ivResults = document.getElementById('ivResults');
      if (ivResults) {
        ivResults.style.display = 'block';
      }
    }

    // ฟังก์ชันเก็บข้อมูลยา
    function saveIRData() {
      const patientId = document.getElementById('patientId')?.value?.trim();
      const medication = document.getElementById('medication')?.value;
      const volume = document.getElementById('volume')?.value;
      const rate = document.getElementById('rate')?.value;

      if (!patientId || !medication || !volume || !rate) {
        alert('กรุณากรอกข้อมูลให้ครบถ้วน');
        return;
      }

      const irData = {
        patient_id: patientId,
        medication: medication,
        volume: volume + 'mL',
        rate: parseInt(rate),
        timestamp: new Date().toISOString(),
        savedBy: JSON.parse(sessionStorage.getItem('currentUser') || '{}').fullname || 'ไม่ระบุ'
      };

      localStorage.setItem(`ir_data_bed_${bedId}`, JSON.stringify(irData));
      displayMedicationInfo(irData);
      alert('บันทึกข้อมูลยาเรียบร้อยแล้ว');
    }

    // ฟังก์ชันแสดงข้อมูลยา
    function displayMedicationInfo(irData) {
      const medicationDisplay = document.getElementById('medicationDisplay');
      if (medicationDisplay && irData) {
        document.getElementById('currentPatientId').textContent = irData.patient_id;
        document.getElementById('currentMedication').textContent = irData.medication;
        document.getElementById('currentRate').textContent = irData.rate;

        // คำนวณและแสดงดรอป/วินาที
        const dropsPerSecond = (irData.rate / 60).toFixed(1);
        document.getElementById('currentRatePerSec').textContent = dropsPerSecond;

        document.getElementById('medicationTime').textContent = new Date(irData.timestamp).toLocaleString('th-TH');
        medicationDisplay.style.display = 'block';
      }
    }

    // ฟังก์ชันโหลดข้อมูลที่มีอยู่
    function loadExistingData() {
      const irDataString = localStorage.getItem(`ir_data_bed_${bedId}`);
      if (irDataString) {
        currentIRData = JSON.parse(irDataString);
        displayMedicationInfo(currentIRData);
      }
    }

    // ฟังก์ชันเพิ่มบันทึก
    function addNote() {
      const noteInput = document.getElementById('noteInput');
      const noteText = noteInput?.value?.trim();

      if (!noteText) {
        alert('กรุณากรอกข้อความบันทึก');
        return;
      }

      const notes = JSON.parse(localStorage.getItem(`nurseNotes_${bedId}`) || '[]');
      const newNote = {
        id: Date.now(),
        content: noteText,
        time: new Date().toLocaleString('th-TH'),
        author: JSON.parse(sessionStorage.getItem('currentUser') || '{}').fullname || 'ไม่ระบุ',
        timestamp: new Date().toISOString(),
        type: 'general'
      };

      notes.unshift(newNote);
      localStorage.setItem(`nurseNotes_${bedId}`, JSON.stringify(notes));

      if (noteInput) noteInput.value = '';
      renderNotes();
    }

    // ฟังก์ชันแสดงบันทึก
    function renderNotes() {
      const notesList = document.getElementById('notesList');
      const notesCount = document.getElementById('notesCount');

      if (!notesList || !notesCount) return;

      const notes = JSON.parse(localStorage.getItem(`nurseNotes_${bedId}`) || '[]');
      notesCount.textContent = `${notes.length} รายการ`;

      if (notes.length === 0) {
        notesList.innerHTML = '<div class="notes-empty-state"><div class="empty-icon">📜</div><div class="empty-title">ไม่มีบันทึก</div><div class="empty-subtitle">เพิ่มบันทึกใหม่ได้เลย</div></div>';
        return;
      }

      notesList.innerHTML = notes.map(note => `
        <div class="note-item">
          <div class="note-header-info">
            <div class="note-author-badge">
              ${note.author}
            </div>
            <div class="note-time-badge">${note.time}</div>
          </div>
          <div class="note-content">
            ${note.content}
          </div>
        </div>
      `).join('');
    }

    // ฟังก์ชันอัพเดทสถานะ
    function updateStatus() {
      generateMockData();
    }

    // ฟังก์ชันเริ่มต้นกราฟ
    function initializeChart() {
      // Chart.js initialization code here
      const ctx = document.getElementById('flowChart');
      if (ctx) {
        // Initialize chart
      }
    }

    // ฟังก์ชันอื่นๆ
    function loadIOHistory() {
      // Load I/O history
    }

    function autoFillCalculator() {
      const volume = document.getElementById('volume')?.value;
      const totalVolumeInput = document.getElementById('totalVolume');
      if (volume && totalVolumeInput && !totalVolumeInput.value) {
        totalVolumeInput.value = volume;
      }
    }

    // ฟังก์ชันออกจากระบบ
    function logout() {
      if (confirm('คุณต้องการออกจากระบบใช่หรือไม่?')) {
        sessionStorage.removeItem('currentUser');
        window.location.href = 'index.html';
      }
    }

    // เริ่มต้นข้อมูลกราฟ
    function initializeFlowData() {
      flowData = []; // ล้างข้อมูลเก่า
      const baseFlow = 25;
      const now = new Date();

      for (let i = 0; i < 20; i++) {
        const time = new Date(now.getTime() - (19 - i) * 60000);
        const variation = Math.random() * 10 - 5;
        const flow = Math.max(15, Math.min(35, baseFlow + variation));

        flowData.push({
          time: time.toLocaleTimeString('th-TH', { hour: '2-digit', minute: '2-digit' }),
          flow: Math.round(flow)
        });
      }
    }

    // ฟังก์ชันคำนวณน้ำเกลือ
    function calculateIVFlow() {
      const totalVolume = parseFloat(document.getElementById('totalVolume').value) || 0;
      const dropFactor = parseInt(document.getElementById('dropFactor').value) || 20;
      const patientWeight = parseFloat(document.getElementById('patientWeight').value) || 0;
      const dropPerMin = parseFloat(document.getElementById('dropPerMin').value) || 0;
      const ccPerHr = parseFloat(document.getElementById('ccPerHr').value) || 0;

      if (!dropPerMin && !ccPerHr) {
        alert('กรุณากรอกอัตราการหยด หรือ อัตราการไหล');
        return;
      }

      // ใช้สูตรจาก IVCalculator
      const result = IVCalculator.calculateComplete({
        dropPerMin,
        ccPerHr,
        totalVolume,
        dropFactor
      });

      displayResults(result, patientWeight);
    }

    // แสดงผลลัพธ์
    function displayResults(result, patientWeight) {
      const resultsGrid = document.getElementById('resultsGrid');
      const timeResult = document.getElementById('timeResult');

      let resultsHTML = '';

      // Drop Factor
      resultsHTML += `
        <div class="result-item">
          <div class="result-label">Drop Factor</div>
          <div class="result-value">${result.dropFactor} หยด/cc</div>
        </div>
      `;

      // อัตราการไหล cc/hr
      const finalCcPerHr = result.calculatedCcPerHr || result.originalCcPerHr;
      if (finalCcPerHr) {
        resultsHTML += `
          <div class="result-item">
            <div class="result-label">อัตราการไหล</div>
            <div class="result-value">${finalCcPerHr.toFixed(1)} cc/hr</div>
          </div>
        `;
      }

      // อัตราการหยด
      const finalDropPerMin = result.calculatedDropPerMin || result.originalDropPerMin;
      if (finalDropPerMin) {
        resultsHTML += `
          <div class="result-item">
            <div class="result-label">อัตราการหยด</div>
            <div class="result-value">${finalDropPerMin.toFixed(1)} หยด/นาที</div>
          </div>
        `;

        // คำนวณหยดต่อวิ
        const dropsPerSecond = (finalDropPerMin / 60).toFixed(1);
        resultsHTML += `
          <div class="result-item">
            <div class="result-label">หยดต่อวิ</div>
            <div class="result-value">${dropsPerSecond} หยด/วิ</div>
          </div>
        `;

        // อัพเดทข้อมูลในกล่องยาหากมีข้อมูลยาอยู่
        if (currentIRData) {
          const medicationRateElement = document.getElementById('currentRate');
          const medicationRatePerSecElement = document.getElementById('currentRatePerSec');
          if (medicationRateElement && medicationRatePerSecElement) {
            medicationRateElement.textContent = finalDropPerMin.toFixed(0);
            medicationRatePerSecElement.textContent = dropsPerSecond;
          }
        }
      }

      // สูตรลัด
      if (result.quickDropPerMin) {
        resultsHTML += `
          <div class="result-item">
            <div class="result-label">สูตรลัด</div>
            <div class="result-value">${result.quickDropPerMin} หยด/นาที</div>
          </div>
        `;
      }

      // ตรวจสอบอัตราต่อน้ำหนัก
      if (patientWeight > 0 && finalCcPerHr) {
        const flowCheck = IVCalculator.checkFlowRate(finalCcPerHr, patientWeight);
        if (flowCheck) {
          const isWarning = flowCheck.recommendation.includes('ควรระวัง');
          resultsHTML += `
            <div class="result-item ${isWarning ? 'warning' : ''}">
              <div class="result-label">อัตราต่อน้ำหนัก</div>
              <div class="result-value">${flowCheck.mlPerKgPerHr} ml/kg/hr</div>
            </div>
            <div class="result-item ${isWarning ? 'warning' : ''}">
              <div class="result-label">คำแนะนำ</div>
              <div class="result-value" style="font-size: 14px;">${flowCheck.recommendation}</div>
            </div>
          `;
        }
      }

      resultsGrid.innerHTML = resultsHTML;

      // แสดงเวลาที่น้ำเกลือจะหมด
      if (result.timeToFinishHours) {
        const hours = Math.floor(result.timeToFinishHours);
        const minutes = Math.round((result.timeToFinishHours - hours) * 60);
        const timeDisplay = hours > 0 ? `${hours} ชั่วโมง ${minutes} นาที` : `${minutes} นาที`;

        timeResult.innerHTML = `
          <div class="result-item highlight" style="display: inline-block; padding: 20px 30px;">
            <div class="result-label">⏱️ เวลาที่น้ำเกลือจะหมด</div>
            <div class="result-value" style="font-size: 22px; color: #f57c00;">${timeDisplay}</div>
          </div>
        `;
      }

      document.getElementById('ivResults').style.display = 'block';
    }

    // บันทึกข้อมูลยา
    function saveMedicationData() {
      const patientId = document.getElementById('patientId').value.trim();
      const medication = document.getElementById('medication').value;
      const volume = document.getElementById('volume').value.trim();
      const rate = document.getElementById('rate').value.trim();

      if (!patientId || !volume || !rate) {
        alert('กรุณากรอกข้อมูลให้ครบถ้วน');
        return;
      }

      const rateNum = parseInt(rate);
      const volumeNum = parseInt(volume);

      if (isNaN(rateNum) || isNaN(volumeNum) || rateNum <= 0 || volumeNum <= 0) {
        alert('กรุณากรอกตัวเลขที่ถูกต้อง');
        return;
      }

      const irData = {
        patient_id: patientId,
        medication: medication,
        volume: volume + "mL",
        rate: rateNum,
        timestamp: new Date().toLocaleString('th-TH')
      };

      // บันทึกลง localStorage
      localStorage.setItem(`ir_data_bed_${bedId}`, JSON.stringify(irData));
      currentIRData = irData;

      // แสดงข้อมูลยา
      displayMedicationInfo(irData);

      // อัพเดทสถานะทันที
      updateStatus();

      // แสดงสัญลักษณ์สำเร็จ
      const saveBtn = document.getElementById('saveBtn');
      const originalText = saveBtn.innerHTML;
      saveBtn.innerHTML = '✅ บันทึกสำเร็จ!';
      saveBtn.style.background = 'linear-gradient(135deg, #4caf50, #388e3c)';

      setTimeout(() => {
        saveBtn.innerHTML = originalText;
        saveBtn.style.background = '';
      }, 2000);

      // บันทึกลงในโน้ต
      const currentUser = JSON.parse(sessionStorage.getItem("currentUser") || "{}");
      const autoNote = {
        content: `📱 บันทึกข้อมูลยา: ${medication} ปริมาณ ${volume}mL อัตรา ${rateNum} ดรอป/นาที (รหัสผู้ป่วย: ${patientId})`,
        time: new Date().toLocaleString("th-TH"),
        author: currentUser.fullname || "ไม่ระบุ",
        userId: currentUser.username || "system",
        type: "medication"
      };

      let nurseNotes = JSON.parse(localStorage.getItem("nurseNotes_" + bedId) || "[]");
      nurseNotes.unshift(autoNote);
      nurseNotes = nurseNotes.slice(0, 50);
      localStorage.setItem("nurseNotes_" + bedId, JSON.stringify(nurseNotes));
      renderNotes();
    }

    // อัพเดทสถานะ
    function updateStatus() {
      try {
        // จำลองข้อมูลใหม่
        const now = new Date();
        const baseFlow = 25;
        const variation = Math.random() * 8 - 4;
        const currentFlow = Math.max(15, Math.min(35, baseFlow + variation));

        const mockData = {
          flow: Math.round(currentFlow),
          timestamp: now.toLocaleString('th-TH')
        };

        const statusDot = document.getElementById('statusDot');
        const currentFlowEl = document.getElementById('currentFlow');
        const orderedFlowEl = document.getElementById('orderedFlow');
        const lastUpdateEl = document.getElementById('lastUpdate');
        const alarmStatusEl = document.getElementById('alarmStatus');

        const orderedFlow = currentIRData ? currentIRData.rate : 0;
        const isAlarm = orderedFlow > 0 && Math.abs(mockData.flow - orderedFlow) > 3;

        if (statusDot) {
          statusDot.className = 'status-indicator ' + (isAlarm ? 'status-warning' : 'status-active');
        }

        if (currentFlowEl) currentFlowEl.textContent = `${mockData.flow} ดรอป/นาที`;
        if (orderedFlowEl) orderedFlowEl.textContent = `${orderedFlow} ดรอป/นาที`;
        if (lastUpdateEl) lastUpdateEl.textContent = mockData.timestamp;

        if (alarmStatusEl) {
          alarmStatusEl.style.display = isAlarm ? 'block' : 'none';
        }

        // อัพเดทกราฟ
        updateChart(mockData);

      } catch (error) {
        console.error('เกิดข้อผิดพลาดในการอัพเดทสถานะ:', error);
      }
    }

    // ฟังก์ชันออกจากระบบ
    function logout() {
      if (confirm('คุณต้องการออกจากระบบใช่หรือไม่?')) {
        sessionStorage.removeItem('currentUser');
        window.location.href = 'index.html';
      }
    }

    // ฟังก์ชันรีเซ็ตข้อมูลเตียง
    function resetBedData() {
      if (confirm(`คุณต้องการรีเซ็ตข้อมูลทั้งหมดของเตียงที่ ${bedId} ใช่หรือไม่?\n\nข้อมูลที่จะถูกลบ:\n- ข้อมูลยาและผู้ป่วย\n- บันทึกพยาบาล\n- ประวัติ I/O\n- การคำนวณน้ำเกลือ`)) {
        // ลบข้อมูลทั้งหมดของเตียงนี้
        localStorage.removeItem(`ir_data_bed_${bedId}`);
        localStorage.removeItem(`nurseNotes_${bedId}`);
        localStorage.removeItem(`io_records_bed_${bedId}`);
        localStorage.removeItem(`fluid_calc_bed_${bedId}`);

        // รีเซ็ตตัวแปรในหน้า
        currentIRData = null;

        // รีเฟรชหน้า
        location.reload();
      }
    }

    // ฟังก์ชันเติมข้อมูลในเครื่องคำนวณอัตโนมัติ
    function autoFillCalculator() {
      const volume = document.getElementById('volume').value;
      const rate = document.getElementById('rate').value;

      if (volume && rate) {
        // เติมข้อมูลในเครื่องคำนวณ
        document.getElementById('totalVolume').value = volume;
        document.getElementById('dropPerMin').value = rate;

        // คำนวณทันที
        setTimeout(() => {
          calculateIVFlow();
        }, 100);
      }
    }

    // Initialize Chart
    function initializeChart() {
      const chartCanvas = document.getElementById('flowChart');
      if (!chartCanvas) {
        console.error('ไม่พบ element flowChart');
        return;
      }

      const ctx = chartCanvas.getContext('2d');
      if (!ctx) {
        console.error('ไม่สามารถสร้าง context ได้');
        return;
      }

      // ตรวจสอบว่า Chart.js โหลดแล้วหรือยัง
      if (typeof Chart === 'undefined') {
        console.error('Chart.js ไม่ได้โหลด');
        return;
      }

      try {
        chartInstance = new Chart(ctx, {
          type: 'line',
          data: {
            labels: flowData.map(d => d.time),
            datasets: [{
              label: 'อัตราการไหล (ดรอป/นาที)',
              data: flowData.map(d => d.flow),
              borderColor: '#4caf50',
              backgroundColor: 'rgba(76, 175, 80, 0.1)',
              borderWidth: 3,
              fill: true,
              tension: 0.4,
              pointBackgroundColor: '#4caf50',
              pointBorderColor: '#2e7d32',
              pointBorderWidth: 2,
              pointRadius: 4
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            animation: {
              duration: 1000
            },
            plugins: {
              legend: {
                display: true,
                position: 'top',
                labels: {
                  color: '#333',
                  font: {
                    family: 'Sarabun',
                    size: 14
                  }
                }
              }
            },
            scales: {
              y: {
                beginAtZero: true,
                min: 0,
                max: 50,
                title: {
                  display: true,
                  text: 'ดรอป/นาที',
                  color: '#666',
                  font: {
                    family: 'Sarabun',
                    size: 12
                  }
                },
                grid: {
                  color: 'rgba(0,0,0,0.1)'
                },
                ticks: {
                  color: '#666',
                  font: {
                    family: 'Sarabun',
                    size: 11
                  }
                }
              },
              x: {
                title: {
                  display: true,
                  text: 'เวลา',
                  color: '#666',
                  font: {
                    family: 'Sarabun',
                    size: 12
                  }
                },
                grid: {
                  color: 'rgba(0,0,0,0.1)'
                },
                ticks: {
                  color: '#666',
                  font: {
                    family: 'Sarabun',
                    size: 11
                  }
                }
              }
            }
          }
        });
        console.log('กราฟถูกสร้างเรียบร้อยแล้ว');
      } catch (error) {
        console.error('เกิดข้อผิดพลาดในการสร้างกราฟ:', error);
      }
    }

    // Update Chart
    function updateChart(data) {
      if (!chartInstance) {
        console.log('กราฟยังไม่ได้เริ่มต้น');
        return;
      }

      try {
        const now = new Date().toLocaleTimeString('th-TH', { hour: '2-digit', minute: '2-digit' });

        // เพิ่มข้อมูลใหม่
        chartInstance.data.labels.push(now);
        chartInstance.data.datasets[0].data.push(data.flow);

        // เก็บแค่ 20 จุดข้อมูลล่าสุด
        if (chartInstance.data.labels.length > 20) {
          chartInstance.data.labels.shift();
          chartInstance.data.datasets[0].data.shift();
        }

        // อัพเดทกราฟ
        chartInstance.update('none'); // ไม่ใช้ animation เพื่อความเร็ว

        // เพิ่มข้อมูลลงใน flowData ด้วย
        flowData.push({
          time: now,
          flow: data.flow
        });

        // เก็บข้อมูลแค่ 20 จุดเช่นกัน
        if (flowData.length > 20) {
          flowData.shift();
        }

      } catch (error) {
        console.error('เกิดข้อผิดพลาดในการอัพเดทกราฟ:', error);
      }
    }

    // I/O Functions
    function toggleIOForm() {
      const form = document.getElementById('ioForm');
      const btn = document.getElementById('toggleIOBtn');

      if (form.style.display === 'none') {
        form.style.display = 'block';
        btn.textContent = '❌ ยกเลิก';
      } else {
        form.style.display = 'none';
        btn.textContent = '+ บันทึก I/O';
        clearIOForm();
      }
    }

    function clearIOForm() {
      const inputs = ['inputWater', 'inputFood', 'inputIV', 'inputBlood', 'inputOther',
                     'outputUrine', 'outputVomit', 'outputDrain', 'outputStool', 'outputOther'];
      inputs.forEach(id => document.getElementById(id).value = '');
      document.getElementById('ioNotes').value = '';
      document.getElementById('ioBalance').style.display = 'none';
    }

    function calculateIOBalance() {
      // Get INPUT values
      const inputWater = parseInt(document.getElementById('inputWater').value) || 0;
      const inputFood = parseInt(document.getElementById('inputFood').value) || 0;
      const inputIV = parseInt(document.getElementById('inputIV').value) || 0;
      const inputBlood = parseInt(document.getElementById('inputBlood').value) || 0;
      const inputOther = parseInt(document.getElementById('inputOther').value) || 0;

      // Get OUTPUT values
      const outputUrine = parseInt(document.getElementById('outputUrine').value) || 0;
      const outputVomit = parseInt(document.getElementById('outputVomit').value) || 0;
      const outputDrain = parseInt(document.getElementById('outputDrain').value) || 0;
      const outputStool = parseInt(document.getElementById('outputStool').value) || 0;
      const outputOther = parseInt(document.getElementById('outputOther').value) || 0;

      // Calculate totals
      const totalIn = inputWater + inputFood + inputIV + inputBlood + inputOther;
      const totalOut = outputUrine + outputVomit + outputDrain + outputStool + outputOther;
      const balance = totalIn - totalOut;

      // Display results
      document.getElementById('totalInput').textContent = totalIn + ' mL';
      document.getElementById('totalOutput').textContent = totalOut + ' mL';

      const balanceElement = document.getElementById('fluidBalance');
      balanceElement.textContent = (balance > 0 ? '+' : '') + balance + ' mL';

      // Color coding for balance
      if (balance > 0) {
        balanceElement.style.color = '#4caf50';
      } else if (balance < 0) {
        balanceElement.style.color = '#f44336';
      } else {
        balanceElement.style.color = '#1976d2';
      }

      document.getElementById('ioBalance').style.display = 'block';
    }

    function saveIORecord() {
      // First calculate balance
      calculateIOBalance();

      // Get all values
      const inputData = {
        water: parseInt(document.getElementById('inputWater').value) || 0,
        food: parseInt(document.getElementById('inputFood').value) || 0,
        iv: parseInt(document.getElementById('inputIV').value) || 0,
        blood: parseInt(document.getElementById('inputBlood').value) || 0,
        other: parseInt(document.getElementById('inputOther').value) || 0
      };

      const outputData = {
        urine: parseInt(document.getElementById('outputUrine').value) || 0,
        vomit: parseInt(document.getElementById('outputVomit').value) || 0,
        drain: parseInt(document.getElementById('outputDrain').value) || 0,
        stool: parseInt(document.getElementById('outputStool').value) || 0,
        other: parseInt(document.getElementById('outputOther').value) || 0
      };

      const totalIn = Object.values(inputData).reduce((a, b) => a + b, 0);
      const totalOut = Object.values(outputData).reduce((a, b) => a + b, 0);
      const balance = totalIn - totalOut;

      // Get shift and notes
      const selectedShift = document.querySelector('input[name="shift"]:checked').value;
      const shiftNames = {
        morning: '🌅 เวรเช้า (06:00-14:00)',
        afternoon: '🌤️ เวรบ่าย (14:00-22:00)', 
        night: '🌙 เวรดึก (22:00-06:00)'
      };
      const ioNotes = document.getElementById('ioNotes').value.trim();

      if (totalIn === 0 && totalOut === 0) {
        alert('กรุณากรอกข้อมูล Input หรือ Output อย่างน้อย 1 รายการ');
        return;
      }

      // Create I/O record
      const currentUser = JSON.parse(sessionStorage.getItem("currentUser") || "{}");
      const ioRecord = {
        bedId: bedId,
        timestamp: new Date().toISOString(),
        time: new Date().toLocaleString('th-TH'),
        shift: selectedShift,
        shiftName: shiftNames[selectedShift],
        input: inputData,
        output: outputData,
        totalIn: totalIn,
        totalOut: totalOut,
        balance: balance,
        notes: ioNotes,
        author: currentUser.fullname || "ไม่ระบุ",
        userId: currentUser.username || "system",
        type: "fluid_balance"
      };

      // Save to localStorage
      let bedIORecords = JSON.parse(localStorage.getItem(`io_records_bed_${bedId}`) || "[]");
      bedIORecords.unshift(ioRecord);
      bedIORecords = bedIORecords.slice(0, 100);
      localStorage.setItem(`io_records_bed_${bedId}`, JSON.stringify(bedIORecords));

      // Add to nurse notes
      const noteContent = `💧 บันทึก I/O ${shiftNames[selectedShift]}: Input ${totalIn}mL, Output ${totalOut}mL, Balance ${balance > 0 ? '+' : ''}${balance}mL${ioNotes ? ' - ' + ioNotes : ''}`;

      const autoNote = {
        content: noteContent,
        time: new Date().toLocaleString("th-TH"),
        author: currentUser.fullname || "ไม่ระบุ",
        userId: currentUser.username || "system",
        type: "fluid_balance"
      };

      let nurseNotes = JSON.parse(localStorage.getItem("nurseNotes_" + bedId) || "[]");
      nurseNotes.unshift(autoNote);
      nurseNotes = nurseNotes.slice(0, 50);
      localStorage.setItem("nurseNotes_" + bedId, JSON.stringify(nurseNotes));

      // Success feedback
      alert(`✅ บันทึก I/O สำเร็จ!\n\nInput: ${totalIn} mL\nOutput: ${totalOut} mL\nBalance: ${balance > 0 ? '+' : ''}${balance} mL`);

      // Clear form and hide it
      clearIOForm();
      toggleIOForm();

      // Refresh displays
      renderNotes();
      loadIOHistory();
    }

    function loadIOHistory() {
      const records = JSON.parse(localStorage.getItem(`io_records_bed_${bedId}`) || "[]");
      const historyList = document.getElementById('ioHistoryList');
      const historyCount = document.getElementById('ioHistoryCount');

      historyCount.textContent = `(${records.length} รายการ)`;

      if (records.length === 0) {
        historyList.innerHTML = '<div style="text-align: center; color: #999; font-style: italic; padding: 15px; font-size: 13px;">ยังไม่มีประวัติการบันทึก I/O</div>';
        return;
      }

      historyList.innerHTML = records.slice(0, 10).map(record => {
        const balanceColor = record.balance > 0 ? '#4caf50' : record.balance < 0 ? '#f44336' : '#1976d2';
        return `
          <div style="background: white; border: 1px solid #e0e0e0; border-radius: 12px; padding: 12px; margin-bottom: 10px; border-left: 4px solid ${balanceColor}; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px; flex-wrap: wrap; gap: 5px;">
              <div style="font-weight: 600; color: #333; font-size: 13px; line-height: 1.2;">
                ${record.shiftName}
              </div>
              <div style="font-size: 10px; color: #666; white-space: nowrap;">${record.time}</div>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 6px; margin-bottom: 8px;">
              <div style="background: linear-gradient(135deg, #e8f5e9, #c8e6c9); padding: 8px 4px; border-radius: 6px; text-align: center;">
                <div style="font-size: 9px; color: #4caf50; font-weight: bold; margin-bottom: 2px;">INPUT</div>
                <div style="font-size: 14px; font-weight: bold; color: #2e7d32; line-height: 1;">${record.totalIn}</div>
                <div style="font-size: 8px; color: #4caf50;">mL</div>
              </div>
              <div style="background: linear-gradient(135deg, #ffebee, #ffcdd2); padding: 8px 4px; border-radius: 6px; text-align: center;">
                <div style="font-size: 9px; color: #f44336; font-weight: bold; margin-bottom: 2px;">OUTPUT</div>
                <div style="font-size: 14px; font-weight: bold; color: #c62828; line-height: 1;">${record.totalOut}</div>
                <div style="font-size: 8px; color: #f44336;">mL</div>
              </div>
              <div style="background: linear-gradient(135deg, #e3f2fd, #bbdefb); padding: 8px 4px; border-radius: 6px; text-align: center;">
                <div style="font-size: 9px; color: #1976d2; font-weight: bold; margin-bottom: 2px;">BALANCE</div>
                <div style="font-size: 14px; font-weight: bold; color: ${balanceColor}; line-height: 1;">
                  ${record.balance > 0 ? '+' : ''}${record.balance}
                </div>
                <div style="font-size: 8px; color: #1976d2;">mL</div>
              </div>
            </div>

            ${record.notes ? `<div style="background: #f8f9fa; padding: 6px 8px; border-radius: 6px; font-size: 11px; color: #666; margin-bottom: 6px; line-height: 1.3;">💬 ${record.notes}</div>` : ''}

            <div style="text-align: right; font-size: 9px; color: #999;">
              👤 ${record.author}
            </div>
          </div>
        `;
      }).join('');
    }

    // บันทึกโน้ต
    function addNote() {
      const noteInput = document.getElementById('noteInput');
      const content = noteInput.value.trim();

      if (!content) {
        alert('กรุณาเพิ่มเนื้อหาบันทึก');
        return;
      }

      const currentUser = JSON.parse(sessionStorage.getItem("currentUser") || "{}");
      const newNote = {
        content: content,
        time: new Date().toLocaleString("th-TH"),
        author: currentUser.fullname || "ไม่ระบุ",
        userId: currentUser.username || "system",
        type: "manual"
      };

      let nurseNotes = JSON.parse(localStorage.getItem("nurseNotes_" + bedId) || "[]");
      nurseNotes.unshift(newNote);
      nurseNotes = nurseNotes.slice(0, 50);
      localStorage.setItem("nurseNotes_" + bedId, JSON.stringify(nurseNotes));

      noteInput.value = '';
      renderNotes();
    }

    // แสดงรายการโน้ต
    function renderNotes() {
      const nurseNotes = JSON.parse(localStorage.getItem("nurseNotes_" + bedId) || "[]");
      const notesList = document.getElementById('notesList');
      const notesCount = document.getElementById('notesCount');

      notesCount.textContent = `${nurseNotes.length} รายการ`;

      if (nurseNotes.length === 0) {
        notesList.innerHTML = '<div class="notes-empty-state"><div class="empty-icon">📜</div><div class="empty-title">ไม่มีบันทึก</div><div class="empty-subtitle">เพิ่มบันทึกใหม่ได้เลย</div></div>';
        return;
      }

      notesList.innerHTML = nurseNotes.map(note => `
        <div class="note-item">
          <div class="note-header-info">
            <div class="note-author-badge">
              ${note.author}
            </div>
            <div class="note-time-badge">${note.time}</div>
          </div>
          <div class="note-content">
            ${note.content}
          </div>
        </div>
      `).join('');
    }

    // Enter key support for note input
    document.getElementById('noteInput').addEventListener('keypress', function(e) {
      if (e.key === 'Enter' && e.ctrlKey) {
        addNote();
      }
    });
  </script>
</body>
</html>
